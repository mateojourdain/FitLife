<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitLife App</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div class="app-container">

        <header class="header">
            <div class="header-info">
                <h1>FitLife</h1>
                <div class="date" id="currentDate"></div>
            </div>
            <div class="settings" onclick="switchPage('settings')"><img src="reglage.png"></div>
        </header>

        <div id="home" class="page active">
            <div class="card gradient-border">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div class="card-label">S√©ances R√©alis√©es (Semaine)</div>
                    <div class="big-stat">
                        <span id="totalSessions">0</span>
                        <span class="stat-goal">/ <span id="weeklyGoal">5</span> Objectif</span>
                    </div>
                    <div class="stats-separator">
                        <div class="background-stat">
                            <div class="stat-line" style="margin-bottom: 8px;">
                                <div class="stat-label">En salle de sport</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--accent-gym);"
                                    id="gymSessions">0</div>
                            </div>
                            <div class="stat-line">
                                <div class="stat-label">A la maison</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--accent-home);"
                                    id="homeSessions">0
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-title">Mon Corps</div>
            <div class="card ripple" onclick="openWeightModal()">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div>
                        <div class="card-label">Poids Actuel</div>
                        <div style="font-size: 28px; font-weight: 900; color: var(--text-primary);"><span
                                id="displayWeight">--</span>
                            <span style="font-size:16px; color: var(--text-secondary);">kg</span>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="card-label">IMC</div>
                        <div style="font-size: 28px; font-weight: 900; color: var(--text-primary);" id="displayBMI">--
                        </div>
                    </div>
                </div>
                <div style="height: 150px; width: 100%;"><canvas id="weightChart"></canvas></div>
                <div
                    style="text-align:center; cursor: pointer; font-size:11px; color:var(--text-secondary); margin-top:10px; text-transform:uppercase; letter-spacing:1px;">
                    Toucher pour mettre √† jour</div>
            </div>

            <div class="section-title">Outils</div>

            <div class="card ripple" onclick="openRmModal()"
                style="display:flex; justify-content:space-between; align-items:center; padding:20px; margin-bottom: 15px;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="icon-box">‚ö°</div>
                    <div>
                        <div style="font-weight:700; color:var(--text-primary); font-size:16px;">Calculateur 1RM</div>
                        <div style="font-size:12px; color:var(--text-secondary);">Estime ta force max sur une seul rep
                        </div>
                    </div>
                </div>
                <div style="color:var(--text-secondary); font-size:20px; cursor: pointer;">‚Ä∫</div>
            </div>

            <div class="card ripple" onclick="openPercentageModal()"
                style="display:flex; justify-content:space-between; align-items:center; padding:20px;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="icon-box">üìä</div>
                    <div>
                        <div style="font-weight:700; color:var(--text-primary); font-size:16px;">Zones de travail</div>
                        <div style="font-size:12px; color:var(--text-secondary);">Calcule ton poids par exercice en %
                        </div>
                    </div>
                </div>
                <div style="color:var(--text-secondary); font-size:20px; cursor: pointer;">‚Ä∫</div>
            </div>

            <div class="card ripple" onclick="openCaloriesModal()"
                style="display:flex; justify-content:space-between; align-items:center; padding:20px; margin-top: 15px;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="icon-box">üî•</div>
                    <div>
                        <div style="font-weight:700; color:var(--text-primary); font-size:16px;">Besoins Caloriques
                        </div>
                        <div style="font-size:12px; color:var(--text-secondary);">Calcule tes calories de maintien</div>
                    </div>
                </div>
                <div style="color:var(--text-secondary); font-size:20px; cursor: pointer;">‚Ä∫</div>
            </div>

        </div>

        <div id="workout" class="page">
            <div class="day-slider-container">
                <button id="prevWeek" class="week-nav-btn">‚Äπ</button>
                <div class="day-slider" id="daySlider"></div>
                <button id="nextWeek" class="week-nav-btn">‚Ä∫</button>
            </div>

            <div id="actionButtonsContainer" style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" id="btnProgram" onclick="openTemplateModal()" style="flex:1;">
                    Programmes</button>
                <button class="btn-primary" id="openFormButton" style="flex:1; margin-bottom:0; ">
                    Nouvelle S√©ance</button>
            </div>

            <div class="section-title" id="recapSectionTitle"
                style="display:none; margin-bottom:15px; margin-top:35px;">
                R√©capitulatif (<span id="recapDateDisplay" style="color:var(--text-primary);"></span>)
            </div>
            <div id="sessionRecap" class="session-recap-container"></div>
        </div>


        <div id="settings" class="page">
            <div class="section-title">Personnalisation</div>
            <div class="card">
                <div class="card-label" style="margin-bottom: 10px;">Th√®me de l'application</div>
                <div class="theme-selector">
                    <div class="theme-option active-theme" data-theme="light" onclick="setTheme('light', this)">
                        <div class="theme-preview preview-light">
                            <div class="dot"></div>
                        </div>
                        <label>Mode Clair</label>
                    </div>
                    <div class="theme-option" data-theme="dark" onclick="setTheme('dark', this)">
                        <div class="theme-preview preview-dark">
                            <div class="dot"></div>
                        </div>
                        <label>Mode Fonc√©</label>
                    </div>
                </div>

            </div>
            <div class="card" style="margin-top: 15px;">
                <div class="card-label" style="margin-bottom: 10px;">Objectif hebdomadaire du nombre de s√©ance</div>
                <div class="form-group">
                    <input type="number" id="weeklyGoalInput" min="1" max="14" placeholder="Ex:5"
                        style="margin-top: 7px;">
                </div>
                <button class="btn-primary" onclick="saveWeeklyGoal()" style="margin-top: 10px;">Enregistrer</button>
            </div>
        </div>
        <div class="modal-overlay hidden" id="addSessionModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2 id="modalTitle">S√©ance</h2><button class="btn-close-text"
                        onclick="closeAddSessionModal()">Fermer</button>
                </div>
                <div class="form-group" id="sessionLocationGroup">
                    <div class="toggle-switch" id="sessionTypeToggle">
                        <button data-type="gym" class="active">Salle de sport</button><button
                            data-type="home">Maison</button>
                    </div>
                </div>
                <div class="form-group"><label>Nom de l'exercice</label><input type="text" id="exerciseName"
                        placeholder="Ex: D√©velopp√© couch√©"></div>
                <div class="form-group row-group">
                    <div class="input-group"><label>S√©ries</label><input type="number" id="sets" value="3"></div>
                    <div class="input-group"><label>R√©p√©titions</label><input type="number" id="reps" value="10"></div>
                </div>
                <div class="form-group"><label>Notes</label><textarea id="notes"
                        placeholder="Sensation, poids..."></textarea></div>
                <div class="modal-actions"><button class="btn-primary full" id="saveSessionButton">Enregistrer</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay hidden" id="weightModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2>Poids & IMC</h2><button class="btn-close-text" onclick="closeWeightModal()">Fermer</button>
                </div>
                <div class="form-group row-group">
                    <div class="input-group"><label>Poids (kg)</label><input type="number" id="inputWeight"
                            placeholder="Ex:0"></div>
                    <div class="input-group"><label>Taille (cm)</label><input type="number" id="inputHeight"
                            placeholder="Ex:175"></div>
                </div>
                <div class="form-group"><label>√Çge (ans)</label><input type="number" id="inputAge" placeholder="Ex:25">
                </div>
                <div class="card"
                    style="margin: 20px 0; text-align:center; border:1px solid var(--border-color); background:var(--bg-tertiary);">
                    <div
                        style="font-size:12px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:1px;">
                        IMC Estim√©</div>
                    <div id="bmiResult"
                        style="font-size:40px; font-weight:900; color:var(--text-primary); line-height:1;">--</div>
                    <div id="bmiText"
                        style="font-size:14px; font-weight:600; color:var(--text-primary); margin-top:5px;">--</div>
                </div>
                <div class="modal-actions"><button class="btn-primary full"
                        onclick="saveWeightData()">Sauvegarder</button></div>
            </div>
        </div>

        <div class="modal-overlay hidden" id="rmModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2>Calculateur 1RM</h2><button class="btn-close-text" onclick="closeRmModal()">Fermer</button>
                </div>
                <div class="form-group row-group">
                    <div class="input-group"><label>Poids (kg)</label><input type="number" id="rmWeight"
                            placeholder="80"></div>
                    <div class="input-group"><label>R√©p√©titions</label><input type="number" id="rmReps" placeholder="8">
                    </div>
                </div>
                <div class="card"
                    style="margin: 20px 0; text-align:center; border:1px solid var(--border-color); background:var(--bg-tertiary);">
                    <div
                        style="font-size:12px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:1px;">
                        Max Th√©orique
                        sur une rep
                    </div>
                    <div id="rmResult" style="font-size:40px; font-weight:900; color:var(--text-primary);">--</div>
                    <div style="font-size:12px; color:var(--text-secondary);">kg</div>
                </div>
                <button class="btn-primary full" onclick="calculateRM()">Calculer</button>
            </div>
        </div>

        <div class="modal-overlay hidden" id="percentageModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2>Zones de travail (%)</h2>
                    <button class="btn-close-text" onclick="closePercentageModal()">Fermer</button>
                </div>
                <div class="form-group">
                    <label>Ton 1RM (Poids Max sur 1 R√©p. en kg)</label>
                    <input type="number" id="percMaxWeight" placeholder="Ex: 100" oninput="calculatePercentages()">
                </div>

                <div id="percentageResults"
                    style="margin-top: 20px; display:flex; flex-direction:column; gap:8px; color:var(--text-primary)">
                    <div style="text-align:center; color:var(--text-secondary); padding: 20px;">
                        Entre ton 1RM pour calculer les poids.
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-overlay hidden" id="templateModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2>Programmes</h2><button class="btn-close-text"
                        onclick="document.getElementById('templateModal').classList.add('hidden')">Fermer</button>
                </div>
                <div id="templateList" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </div>

        <div class="modal-overlay hidden" id="caloriesModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2>Calories</h2>
                    <button class="btn-close-text" onclick="closeCaloriesModal()">Fermer</button>
                </div>

                <div class="form-group">
                    <label>Sexe</label>
                    <div class="toggle-switch" id="genderToggle">
                        <button data-sex="male" class="active" onclick="setCalorieGender('male', this)">Homme</button>
                        <button data-sex="female" onclick="setCalorieGender('female', this)">Femme</button>
                    </div>
                </div>

                <div class="form-group row-group">
                    <div class="input-group"><label>Poids (kg)</label><input type="number" id="calWeight"
                            placeholder="Ex: 75"></div>
                    <div class="input-group"><label>Taille (cm)</label><input type="number" id="calHeight"
                            placeholder="Ex: 180"></div>
                </div>

                <div class="form-group row-group">
                    <div class="input-group"><label>√Çge (ans)</label><input type="number" id="calAge"
                            placeholder="Ex: 25"></div>
                </div>

                <div class="form-group">
                    <label>Niveau d'activit√©</label>
                    <select id="calActivity"
                        style="width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--input-text); padding: 12px; border-radius: 10px; font-size: 16px; outline: none; appearance: none;">
                        <option value="1.2">S√©dentaire (Peu ou pas de sport)</option>
                        <option value="1.375">L√©ger (Sport 1-3 fois/semaine)</option>
                        <option value="1.55">Mod√©r√© (Sport 3-5 fois/semaine)</option>
                        <option value="1.725">Actif (Sport 6-7 fois/semaine)</option>
                        <option value="1.9">Tr√®s actif (Job physique + sport)</option>
                    </select>
                </div>

                <div class="card"
                    style="margin: 20px 0; text-align:center; border:1px solid var(--border-color); background:var(--bg-tertiary);">
                    <div
                        style="font-size:12px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">
                        Maintien Quotidien
                    </div>
                    <div id="calResult"
                        style="font-size:40px; font-weight:900; color:var(--text-primary); line-height:1;">--</div>
                    <div style="font-size:12px; color:var(--text-secondary); margin-top:5px;">Kcal / jour
                    </div>
                </div>

                <button class="btn-primary full" onclick="calculateCalories()">Calculer</button>
            </div>
        </div>

        <div class="modal-overlay hidden full-screen" id="activeSessionModal">
            <div class="active-session-content">
                <div class="active-session-header">
                    <h2 id="activeSessionTitle">S√©ance en cours</h2>
                    <button class="btn-close-text" onclick="closeActiveSessionModal()">Terminer & Fermer</button>
                </div>

                <div id="activeWorkoutDetails">
                </div>

                <div class="main-action-btn">
                    <button class="btn-primary full" id="finishSeriesButton" onclick="finishSeries()">
                        S√âRIE TERMIN√âE (Prochaine: 90s)
                    </button>
                </div>
            </div>
        </div>
        <div id="smartTimer" class="timer-float hidden">
            <div style="display:flex; flex-direction:column;">
                <span style="font-size:10px; color:var(--text-secondary); font-weight:700;">REPOS</span>
                <span id="timerDisplay"
                    style="font-size:20px; font-weight:700; color:var(--text-primary); font-family:monospace;">01:30</span>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="timer-btn" onclick="adjustTimer(-10)">-10</button>
                <button class="timer-btn" onclick="adjustTimer(+10)">+10</button>
                <button class="timer-btn stop" onclick="stopTimer()">‚úï</button>
            </div>
            <div class="timer-bar" id="timerBar"></div>
        </div>
        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchPage('home')">
                <div class="nav-icon"><img src="home.png"></div>
                <div class="nav-label">Accueil</div>
            </button>
            <button class="nav-item" onclick="switchPage('workout')">
                <div class="nav-icon"><img src="haltere.png"></div>
                <div class="nav-label">Sport</div>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =================================================================
            // LOGIQUE DE GESTION DU TH√àME
            // =================================================================
            const body = document.body;
            const themeOptions = document.querySelectorAll('.theme-option');
            let chartInstance = null; // Pour stocker l'instance du graphique de poids

            window.setTheme = (theme, element) => {
                if (theme === 'dark') {
                    body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }

                // Met √† jour l'√©tat actif des boutons dans la page de r√©glages
                if (themeOptions.length > 0) {
                    themeOptions.forEach(opt => opt.classList.remove('active-theme'));
                    const target = document.querySelector(`.theme-option[data-theme="${theme}"]`);
                    if (target) target.classList.add('active-theme');
                }

                // CRUCIAL : Relance l'UI du poids pour mettre √† jour les couleurs du graphique
                if (document.getElementById('weightChart')) {
                    updateWeightUI();
                }
            };

            // =================================================================
            // LOGIQUE DE NAVIGATION
            // =================================================================
            window.switchPage = (pageId) => {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                document.getElementById(pageId).classList.add('active');

                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`.nav-item[onclick="switchPage('${pageId}')"]`).classList.add('active');
                // Si on va sur la page workout, on met √† jour la s√©lection
                if (pageId === 'workout') {
                    selectDay(currentSelectedDate);
                }
            };


            // =================================================================
            // GESTION DU STOCKAGE ET DES DATES
            // =================================================================
            const WEIGHT_STORAGE_KEY = 'weightHistory';
            const SESSION_STORAGE_KEY = 'workoutSessions';

            let weightHistory = JSON.parse(localStorage.getItem(WEIGHT_STORAGE_KEY) || '[]');
            let currentSelectedDate = new Date();
            let currentWeekStart;
            let sessionType = 'gym'; // Type de s√©ance par d√©faut pour le formulaire

            function getSessions() {
                return JSON.parse(localStorage.getItem(SESSION_STORAGE_KEY) || '{}');
            }

            function saveSessions(sessions) {
                localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(sessions));
            }

            function formatDateKey(d) {
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            }

            function formatDateDisplay(d) {
                return d.toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long'
                });
            }

            function isPastDate(d) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const check = new Date(d);
                check.setHours(0, 0, 0, 0);
                return check.getTime() < today.getTime();
            }

            function getWeeklyGoal() {
                const saved = localStorage.getItem('weeklyGoal');
                return saved ? parseInt(saved) : 5;
            }

            function updateWeeklyGoalDisplay() {
                const goal = getWeeklyGoal();
                document.getElementById('weeklyGoal').textContent = goal;
            }

            window.saveWeeklyGoal = () => {
                const input = document.getElementById('weeklyGoalInput');
                const goal = parseInt(input.value);
                if (goal >= 1 && goal <= 14) {
                    localStorage.setItem('weeklyGoal', goal.toString());
                    updateWeeklyGoalDisplay();
                    alert('Nouvel objectif hebdomadaire modifi√© !');
                } else {
                    alert('Veuillez entrer un nombre entre 1 et 14');
                }
            }

            function getWeekStart(date) {
                const d = new Date(date);
                const day = d.getDay(); // 0 = Dimanche, 1 = Lundi, ..., 6 = Samedi
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Ajuste au Lundi
                const weekStart = new Date(d.setDate(diff));
                weekStart.setHours(0, 0, 0, 0);
                return weekStart;
            }

            function renderDaySlider(startOfWeek) {
                const slider = document.getElementById('daySlider');
                slider.innerHTML = '';
                const allSessions = getSessions();
                let selectedDayFound = false;
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(startOfWeek);
                    dayDate.setDate(startOfWeek.getDate() + i);
                    const key = formatDateKey(dayDate);
                    const dayName = dayDate.toLocaleDateString('fr-FR', {
                        weekday: 'short'
                    }).substring(0, 3).toUpperCase();

                    const el = document.createElement('div');
                    el.classList.add('slider-day');

                    if (allSessions[key] && allSessions[key].exercises.length > 0) {
                        el.classList.add('has-session');
                        el.classList.add(allSessions[key].type);
                    }

                    if (dayDate.toDateString() === today.toDateString()) {
                        el.classList.add('today');
                    }

                    if (isPastDate(dayDate)) {
                        el.classList.add('past');
                    }

                    if (dayDate.toDateString() === currentSelectedDate.toDateString()) {
                        el.classList.add('selected');
                        selectedDayFound = true;
                    }

                    el.innerHTML = `<div class="day-name">${dayName}</div><div class="day-num">${dayDate.getDate()}</div>`;
                    el.onclick = () => selectDay(dayDate);
                    slider.appendChild(el);
                }

                // S'assurer que le jour s√©lectionn√© est visible
if (selectedDayFound) {
                    const selectedEl = slider.querySelector('.slider-day.selected');
                    if (selectedEl) {
                        selectedEl.scrollIntoView({
                            behavior: 'instant', // <-- Chang√© √† 'instant' pour ne pas interf√©rer avec le swipe
                            inline: 'center',
                            block: 'nearest'
                        });
                    }
                }
            }

            window.prevWeek = () => {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                renderDaySlider(currentWeekStart);
            };

            window.nextWeek = () => {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                renderDaySlider(currentWeekStart);
            };

            window.selectDay = (date) => {
                currentSelectedDate = date;
                // Met √† jour la s√©lection visuelle
                document.querySelectorAll('.slider-day').forEach(el => {
                    el.classList.remove('selected');
                    const key = formatDateKey(date);
                    const dateFromElement = new Date(currentWeekStart);
                    dateFromElement.setDate(currentWeekStart.getDate() + Array.from(document.getElementById('daySlider').children).indexOf(el));
                    if (dateFromElement.toDateString() === date.toDateString()) {
                        el.classList.add('selected');
                    }
                });

                displaySessionRecap(date);
            }

            function displaySessionRecap(date) {
                const container = document.getElementById('sessionRecap');
                container.innerHTML = '';
                const key = formatDateKey(date);
                const sessionData = getSessions()[key];
                const dateDisplay = formatDateDisplay(date);
                const isPast = isPastDate(date);

                document.getElementById('recapDateDisplay').textContent = dateDisplay;
                document.getElementById('recapSectionTitle').style.display = 'none';

                if (!sessionData || sessionData.exercises.length === 0) {
                    container.innerHTML = isPast ?
                        `<div style="text-align:center; padding: 20px; color:var(--text-secondary);">Aucune s√©ance enregistr√©e pour cette date.</div>` :
                        `<div style="text-align:center; padding: 20px; color:var(--text-secondary);">Programme ta s√©ance pour le ${dateDisplay}.</div>`;
                    return;
                }

                if (sessionData && sessionData.exercises.length > 0) {
                    document.getElementById('recapSectionTitle').style.display = 'block';

                    // NOUVEAU: Bouton D√©marrer la S√©ance si ce n'est pas une date pass√©e
                    if (!isPast) {
                        const startBtnContainer = document.createElement('div');
                        startBtnContainer.style.marginBottom = '25px';
                        startBtnContainer.innerHTML = `<button class="btn-primary full" style="margin-top:0; margin-bottom:0;" onclick="startWorkout('${key}')">D√âMARRER LA S√âANCE</button>`;
                        container.appendChild(startBtnContainer);
                    }

                    sessionData.exercises.forEach((exercise, index) => {
                        const exElement = document.createElement('div');
                        exElement.className = 'exercise-card';
                        exElement.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div>
                                    <h3>${exercise.name}</h3>
                                    <div class="exercise-meta">${exercise.sets} s√©ries de ${exercise.reps} reps</div>
                                </div>
                                <div class="action-icons">
                                    <span class="icon-edit" onclick="openAddExerciseModal(${index}, getSessions()['${key}'].exercises[${index}])">‚úé</span>
                                    <span class="icon-delete" onclick="deleteExercise(${index})">‚úï</span>
                                </div>
                            </div>
                            ${exercise.notes ? `<p class="exercise-notes">${exercise.notes}</p>` : ''}
                        `;
                        container.appendChild(exElement);
                    });
                }
            }
            
            // CORRECTION: Utilisation de JSON.stringify pour passer l'objet exercise correctement
            // et √©viter les erreurs de syntaxe dans l'appel `onclick` dans le HTML g√©n√©r√©.
            function createEditHtml(index, exercise) {
                const exString = JSON.stringify(exercise).replace(/"/g, '&quot;');
                return `<span class="icon-edit" onclick="openAddExerciseModal(${index}, ${exString})">‚úé</span>`;
            }

            // MODIFICATION APPORT√âE ICI
            function displaySessionRecap(date) {
                const container = document.getElementById('sessionRecap');
                container.innerHTML = '';
                const key = formatDateKey(date);
                const sessionData = getSessions()[key];
                const dateDisplay = formatDateDisplay(date);
                const isPast = isPastDate(date);

                document.getElementById('recapDateDisplay').textContent = dateDisplay;
                document.getElementById('recapSectionTitle').style.display = 'none';

                if (!sessionData || sessionData.exercises.length === 0) {
                    container.innerHTML = isPast ?
                        `<div style="text-align:center; padding: 20px; color:var(--text-secondary);">Aucune s√©ance enregistr√©e pour cette date.</div>` :
                        `<div style="text-align:center; padding: 20px; color:var(--text-secondary);">Programme ta s√©ance pour le ${dateDisplay}.</div>`;
                    return;
                }

                if (sessionData && sessionData.exercises.length > 0) {
                    document.getElementById('recapSectionTitle').style.display = 'block';

                    if (!isPast) {
                        const startBtnContainer = document.createElement('div');
                        startBtnContainer.style.marginBottom = '25px';
                        startBtnContainer.innerHTML = `<button class="btn-primary full" style="margin-top:0; margin-bottom:0;" onclick="startWorkout('${key}')">D√âMARRER LA S√âANCE</button>`;
                        container.appendChild(startBtnContainer);
                    }

                    sessionData.exercises.forEach((exercise, index) => {
                        const exElement = document.createElement('div');
                        exElement.className = 'exercise-card';
                        
                        // CORRECTION APPORT√âE DANS CETTE LIGNE
                        const editIconHtml = `<span class="icon-edit" onclick="openAddExerciseModal(${index}, ${JSON.stringify(exercise).replace(/"/g, '&quot;')})">‚úé</span>`;

                        exElement.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div>
                                    <h3>${exercise.name}</h3>
                                    <div class="exercise-meta">${exercise.sets} s√©ries de ${exercise.reps} reps</div>
                                </div>
                                <div class="action-icons">
                                    ${editIconHtml} 
                                    <span class="icon-delete" onclick="deleteExercise(${index})">‚úï</span>
                                </div>
                            </div>
                            ${exercise.notes ? `<p class="exercise-notes">${exercise.notes}</p>` : ''}
                        `;
                        container.appendChild(exElement);
                    });
                }
            }


            window.openAddExerciseModal = (index, exercise) => {
                // S'assure que exercise est un objet s'il est pass√© en tant que string par le HTML
                if (typeof exercise === 'string') {
                    try {
                        exercise = JSON.parse(exercise);
                    } catch (e) {
                        console.error("Erreur lors du parsing de l'exercice:", e);
                        exercise = null;
                    }
                }
                
                if (isPastDate(currentSelectedDate) && index === null) return alert('Impossible d\'ajouter un exercice pour une date pass√©e.');
                
                const allSessions = getSessions();
                const dateKey = formatDateKey(currentSelectedDate);
                const sessionLocationGroup = document.getElementById('sessionLocationGroup');
                const modalTitle = document.getElementById('modalTitle');

                modalTitle.textContent = index !== null ? 'Modifier l\'exercice' : 'Nouvel exercice';

                if (allSessions[dateKey] && allSessions[dateKey].exercises.length > 0) {
                    // Si la session existe d√©j√†, on cache le toggle car le type est d√©fini
                    sessionLocationGroup.style.display = 'none';
                } else {
                    // Sinon, c'est un ajout et la premi√®re fois qu'on cr√©e une nouvelle session, on affiche le toggle
                    sessionLocationGroup.style.display = 'flex';
                }

                if (exercise) {
                    document.getElementById('exerciseName').value = exercise.name || '';
                    document.getElementById('sets').value = exercise.sets || 3;
                    document.getElementById('reps').value = exercise.reps || 10;
                    document.getElementById('notes').value = exercise.notes || '';
                    document.getElementById('saveSessionButton').dataset.editIndex = index;
                } else {
                    document.getElementById('exerciseName').value = '';
                    document.getElementById('sets').value = 3;
                    document.getElementById('reps').value = 10;
                    document.getElementById('notes').value = '';
                    document.getElementById('saveSessionButton').dataset.editIndex = null;
                }

                // R√©cup√®re le type de session actuel pour l'initialisation du toggle
                if (allSessions[dateKey]) {
                    sessionType = allSessions[dateKey].type;
                } else {
                    // Sinon, r√©initialise au d√©faut ou garde le dernier s√©lectionn√©
                    sessionType = 'gym';
                }

                // Met √† jour l'√©tat visuel du toggle pour correspondre au jour
                document.querySelectorAll('#sessionTypeToggle button').forEach(b => {
                    b.classList.remove('active');
                    if (b.dataset.type === sessionType) {
                        b.classList.add('active');
                    }
                });

                document.getElementById('addSessionModal').classList.remove('hidden');
                document.body.classList.add('modal-open');
            }

            window.closeAddSessionModal = () => {
                document.getElementById('addSessionModal').classList.add('hidden');
                document.body.classList.remove('modal-open');
            }

            window.deleteExercise = (idx) => {
                if (isPastDate(currentSelectedDate)) return alert('Impossible de supprimer des exercices pour une date pass√©e.');
                if (confirm('√ätes-vous s√ªr de vouloir supprimer cet exercice ?')) {
                    const all = getSessions();
                    const dateKey = formatDateKey(currentSelectedDate);
                    all[dateKey].exercises.splice(idx, 1);
                    if (all[dateKey].exercises.length === 0) delete all[dateKey];
                    saveSessions(all);
                    selectDay(currentSelectedDate);
                    updateDashboardSessions();
                    renderDaySlider(currentWeekStart);
                }
            }
            
            document.querySelectorAll('.toggle-switch button[data-type]').forEach(btn => {
                btn.addEventListener('click', () => {
                    sessionType = btn.dataset.type;
                    document.querySelectorAll('.toggle-switch button[data-type]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // =================================================================
            // LOGIQUE DE SAUVEGARDE (CORRIG√âE)
            // =================================================================
            document.getElementById('saveSessionButton').addEventListener('click', () => {
                const name = document.getElementById('exerciseName').value;
                const sets = parseInt(document.getElementById('sets').value);
                const reps = parseInt(document.getElementById('reps').value);
                if (!name) return alert('Nom manquant');

                const key = formatDateKey(currentSelectedDate);
                const all = getSessions();

                // Si la session n'existe pas encore, on la cr√©e avec le type actuel
                if (!all[key]) all[key] = {
                    type: sessionType,
                    exercises: []
                };

                const newEx = {
                    name,
                    sets,
                    reps,
                    notes: document.getElementById('notes').value,
                    series: []
                };

                // Initialise les s√©ries
                for (let i = 0; i < sets; i++) newEx.series.push({
                    reps,
                    isDone: false
                });

                const indexToEdit = document.getElementById('saveSessionButton').dataset.editIndex;
                if (indexToEdit !== undefined && indexToEdit !== null && indexToEdit !== 'null') {
                    // C'est une modification
                    all[key].exercises[parseInt(indexToEdit)] = newEx; 
                } else {
                    // C'est un ajout
                    all[key].exercises.push(newEx); 
                }

                // 1. Sauvegarder les donn√©es
                saveSessions(all);
                
                // 2. Fermer la modale
                closeAddSessionModal();
                
                // 3. Basculer sur la page Sport (ASSURE L'AFFICHAGE DU R√âCAPITULATIF)
                window.switchPage('workout'); 

                // 4. Mettre √† jour la vue du jour s√©lectionn√©
                selectDay(currentSelectedDate); 
                
                // 5. Mettre √† jour les statistiques du tableau de bord
                updateDashboardSessions();
                
                // 6. Mettre √† jour le slider des jours
                renderDaySlider(currentWeekStart); 
            });


            // =================================================================
            // GESTION DES PROGRAMMES (TEMPLATES)
            // =================================================================

            function applyTemplate(templateKey) {
                if (isPastDate(currentSelectedDate)) return alert('Impossible d\'appliquer un programme pour une date pass√©e.');

                const dateKey = formatDateKey(currentSelectedDate);
                const all = getSessions();

                let exercises = [];
                let type = 'gym';

                switch (templateKey) {
                    case 'haut-du-corps':
                        exercises = [
                            { name: 'D√©velopp√© Couch√©', s: 4, r: 8 },
                            { name: 'Tirage Vertical (Poulie Haute)', s: 4, r: 10 },
                            { name: 'D√©velopp√© Militaire (Halt√®res)', s: 3, r: 10 },
                            { name: 'Rowing Halt√®re', s: 3, r: 10 },
                            { name: 'Extension Triceps', s: 3, r: 12 },
                            { name: 'Curl Biceps', s: 3, r: 12 }
                        ];
                        type = 'gym';
                        break;
                    case 'bas-du-corps':
                        exercises = [
                            { name: 'Squat Barre', s: 5, r: 5 },
                            { name: 'Soulev√© de Terre Roumain', s: 3, r: 10 },
                            { name: 'Presse √† Cuisses', s: 3, r: 12 },
                            { name: 'Leg Extension', s: 3, r: 15 },
                            { name: 'Mollets Debout', s: 4, r: 15 }
                        ];
                        type = 'gym';
                        break;
                    case 'full-body':
                        exercises = [
                            { name: 'Pompes', s: 3, r: 15 },
                            { name: 'Fentes March√©es', s: 3, r: 12 },
                            { name: 'Tirage Invers√© (Sous une table)', s: 3, r: 10 },
                            { name: 'Squat au poids du corps', s: 3, r: 20 },
                            { name: 'Planche', s: 3, r: 60 }
                        ];
                        type = 'home';
                        break;
                    default:
                        return;
                }

                // Initialiser la session pour le jour
                all[dateKey] = {
                    type: type,
                    exercises: []
                };

                exercises.forEach(ex => {
                    const newEx = {
                        name: ex.name,
                        sets: ex.s,
                        reps: ex.r,
                        notes: '',
                        series: []
                    };
                    for (let i = 0; i < ex.s; i++) newEx.series.push({
                        reps: ex.r,
                        isDone: false
                    });
                    all[dateKey].exercises.push(newEx);
                });

                saveSessions(all);
                document.getElementById('templateModal').classList.add('hidden');
                selectDay(currentSelectedDate);
                updateDashboardSessions();
                renderDaySlider(currentWeekStart);
            }

            window.openTemplateModal = () => {
                if (isPastDate(currentSelectedDate)) return;
                const list = document.getElementById('templateList');
                list.innerHTML = '';
                const templates = {
                    'haut-du-corps': 'Haut du Corps (Push/Pull)',
                    'bas-du-corps': 'Bas du Corps (Jambes)',
                    'full-body': 'Full Body (Maison)'
                };

                Object.keys(templates).forEach(key => {
                    const btn = document.createElement('button');
                    btn.className = 'btn-secondary';
                    btn.style.width = '100%';
                    btn.style.marginBottom = '10px';
                    btn.style.marginTop = '0';
                    btn.textContent = templates[key];
                    btn.onclick = () => applyTemplate(key);
                    list.appendChild(btn);
                });

                // Option pour commencer √† z√©ro
                const clearBtn = document.createElement('button');
                clearBtn.className = 'btn-secondary';
                clearBtn.style.width = '100%';
                clearBtn.style.marginTop = '10px';
                clearBtn.style.backgroundColor = 'var(--bg-primary)';
                clearBtn.textContent = 'Effacer les exercices existants et commencer un programme';
                clearBtn.onclick = () => {
                    if (confirm("√ätes-vous s√ªr de vouloir effacer le programme existant pour cette date?")) {
                        const dateKey = formatDateKey(currentSelectedDate);
                        const all = getSessions();
                        if (all[dateKey]) {
                            all[dateKey].exercises = [];
                            saveSessions(all);
                            selectDay(currentSelectedDate);
                        }
                        // Ouvre √† nouveau la modale pour choisir le template
                        // (On la referme si l'utilisateur annule, mais l√† on veut qu'il choisisse)
                    }
                };
                list.appendChild(clearBtn);

                document.getElementById('templateModal').classList.remove('hidden');
            }


            function updateDashboardSessions() {
                const allSessions = getSessions();
                let total = 0;
                let gym = 0;
                let home = 0;
                const now = new Date();
                const startOfWeek = getWeekStart(now);

                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(startOfWeek);
                    dayDate.setDate(startOfWeek.getDate() + i);
                    const key = formatDateKey(dayDate);

                    if (allSessions[key] && allSessions[key].exercises.length > 0) {
                        // On compte uniquement les s√©ances pass√©es
                        if (isPastDate(dayDate) || dayDate.toDateString() === now.toDateString()) {
                            total++;
                            if (allSessions[key].type === 'gym') {
                                gym++;
                            } else {
                                home++;
                            }
                        }
                    }
                }

                document.getElementById('totalSessions').textContent = total;
                document.getElementById('gymSessions').textContent = gym;
                document.getElementById('homeSessions').textContent = home;

                // Met √† jour la date actuelle dans le header
                document.getElementById('currentDate').textContent = now.toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'short'
                });
            }


            // =================================================================
            // LOGIQUE PENDANT LA S√âANCE ACTIVE (NOUVEAU)
            // =================================================================
            let activeSessionDateKey = null;
            let activeExerciseIndex = 0;
            let activeSeriesIndex = 0;

            window.startWorkout = (dateKey) => {
                activeSessionDateKey = dateKey;
                activeExerciseIndex = 0;
                activeSeriesIndex = 0;
                stopTimer(); // S'assurer que le timer est √©teint au d√©but

                const allSessions = getSessions();
                if (!allSessions[dateKey] || allSessions[dateKey].exercises.length === 0) {
                    return alert("Aucun exercice programm√© pour cette journ√©e.");
                }

                // Parcourt les exercices pour trouver o√π reprendre
                let resumed = false;
                for (let i = 0; i < allSessions[dateKey].exercises.length; i++) {
                    const ex = allSessions[dateKey].exercises[i];
                    for (let j = 0; j < ex.series.length; j++) {
                        if (!ex.series[j].isDone) {
                            activeExerciseIndex = i;
                            activeSeriesIndex = j;
                            resumed = true;
                            break;
                        }
                    }
                    if (resumed) break;
                }

                // Si tout est fini, on recommence au d√©but (ou on alerte)
                if (!resumed) {
                    if (confirm("Tous les exercices sont marqu√©s comme termin√©s. Voulez-vous recommencer la s√©ance ?")) {
                        // R√©initialiser toutes les s√©ries √† isDone: false
                        allSessions[dateKey].exercises.forEach(ex => {
                            ex.series.forEach(s => s.isDone = false);
                        });
                        saveSessions(allSessions);
                        activeExerciseIndex = 0;
                        activeSeriesIndex = 0;
                    } else {
                        return; // L'utilisateur annule le red√©marrage
                    }
                }

                updateActiveWorkoutUI();
                document.getElementById('activeSessionModal').classList.remove('hidden');
                document.body.classList.add('modal-open');
            };

            window.closeActiveSessionModal = () => {
                stopTimer();
                document.getElementById('activeSessionModal').classList.add('hidden');
                document.body.classList.remove('modal-open');
                // Rafra√Æchir le r√©capitulatif apr√®s la fermeture
                selectDay(currentSelectedDate);
                updateDashboardSessions();
            };

            window.finishSeries = () => {
                const allSessions = getSessions();
                const session = allSessions[activeSessionDateKey];
                if (!session) return;

                const currentEx = session.exercises[activeExerciseIndex];
                if (!currentEx) return;


                // 1. Marquer la s√©rie actuelle comme termin√©e
                if (currentEx.series[activeSeriesIndex]) {
                    currentEx.series[activeSeriesIndex].isDone = true;
                    saveSessions(allSessions); // Sauvegarder imm√©diatement
                }

                // 2. Passer √† la s√©rie suivante
                activeSeriesIndex++;

                // 3. V√©rifier si on passe √† l'exercice suivant ou si la s√©ance est finie
                let isSessionFinished = false;
                if (activeSeriesIndex >= currentEx.sets) {
                    // Toutes les s√©ries de l'exercice actuel sont termin√©es
                    activeExerciseIndex++;
                    activeSeriesIndex = 0;
                    if (activeExerciseIndex >= session.exercises.length) {
                        // S√©ance termin√©e!
                        isSessionFinished = true;
                    }
                }

                if (isSessionFinished) {
                    // Pas de repos si c'est la toute fin de s√©ance
                    stopTimer();
                    alert("F√©licitations, la s√©ance est termin√©e ! Vous pouvez maintenant fermer la fen√™tre.");
                } else {
                    // 4. D√©clencher le chronom√®tre de repos (90s par d√©faut)
                    // On peut ajuster le temps de repos ici si on voulait une r√®gle plus complexe
                    startTimer(90);
                }

                // 5. Mettre √† jour l'interface utilisateur
                updateActiveWorkoutUI();
            };

            function updateActiveWorkoutUI() {
                const allSessions = getSessions();
                const session = allSessions[activeSessionDateKey];
                const container = document.getElementById('activeWorkoutDetails');
                container.innerHTML = '';
                if (!session) return;

                document.getElementById('activeSessionTitle').textContent = `S√©ance ${session.type === 'gym' ? 'Salle de sport' : 'Maison'}`;

                let allFinished = true; // Pour v√©rifier si la s√©ance est termin√©e

                session.exercises.forEach((ex, exIdx) => {
                    const isActiveEx = exIdx === activeExerciseIndex;
                    let seriesHtml = '';
                    ex.series.forEach((s, sIdx) => {
                        let statusClass = s.isDone ? 'done-series' : '';
                        let statusText = s.isDone ? 'FAIT' : '√Ä FAIRE';

                        if (!s.isDone) {
                            allFinished = false; // Il reste au moins une s√©rie √† faire
                        }

                        if (isActiveEx && sIdx === activeSeriesIndex && !s.isDone) {
                            statusClass = 'current-series';
                            statusText = 'EN COURS';
                        }

                        seriesHtml += ` 
                            <li class="active-series-item ${statusClass}"> 
                                <div style="font-weight:600;">S√©rie ${sIdx + 1}: ${s.reps} R√©p.</div> 
                                <div class="series-status">${statusText}</div> 
                            </li> 
                        `;
                    });

                    const exElement = document.createElement('div');
                    exElement.className = `exercise-block ${isActiveEx ? 'active-exercise' : ''}`;
                    exElement.innerHTML = `
                        <h3>${ex.name}</h3>
                        <div class="exercise-block-meta">${ex.sets} s√©ries de ${ex.reps} reps</div>
                        ${ex.notes ? `<p class="exercise-notes">${ex.notes}</p>` : ''}
                        <ul class="active-series-list">${seriesHtml}</ul>
                    `;
                    container.appendChild(exElement);
                });

                // Mettre √† jour le bouton principal
                const finishBtn = document.getElementById('finishSeriesButton');
                if (allFinished) {
                    finishBtn.textContent = "S√âANCE TERMIN√âE (Fermer)";
                    finishBtn.onclick = closeActiveSessionModal;
                } else {
                    const nextRestTime = 90; // Temps de repos par d√©faut
                    finishBtn.textContent = `S√âRIE TERMIN√âE (Repos: ${nextRestTime}s)`;
                    finishBtn.onclick = window.finishSeries;
                }
            }


            // =================================================================
            // LOGIQUE DU CHRONOM√àTRE DE REPOS FLOTTANT
            // =================================================================
            let timerInterval;
            let timerStartTime;
            let timerDuration;
            let timerRunning = false;

            window.startTimer = (durationInSeconds) => {
                stopTimer(); // Arr√™te tout timer existant
                timerDuration = durationInSeconds;
                timerStartTime = Date.now();
                timerRunning = true;
                const timerFloat = document.getElementById('smartTimer');
                timerFloat.classList.remove('hidden');

                // R√©initialise la barre de progression
                document.getElementById('timerBar').style.transition = 'none'; // Reset transition instantly
                document.getElementById('timerBar').style.width = '100%';


                const updateDisplay = () => {
                    const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
                    const remaining = timerDuration - elapsed;

                    if (remaining <= 0) {
                        stopTimer(true);
                        document.getElementById('timerDisplay').textContent = "00:00";
                        // Alerte sonore ou vibration ici
                        if (navigator.vibrate) navigator.vibrate([200, 100, 200]); // Vibre 
                        // Le timer reste visible mais √† 00:00.
                        return;
                    }

                    const minutes = Math.floor(remaining / 60);
                    const seconds = remaining % 60;
                    document.getElementById('timerDisplay').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                    // Met √† jour la barre de progression avec une transition anim√©e
                    const percentage = (remaining / timerDuration) * 100;
                    document.getElementById('timerBar').style.transition = 'width 1s linear';
                    document.getElementById('timerBar').style.width = `${percentage}%`;
                };

                updateDisplay(); // Mise √† jour imm√©diate
                timerInterval = setInterval(updateDisplay, 1000);
            };

            window.stopTimer = (hide = true) => {
                clearInterval(timerInterval);
                timerRunning = false;
                if (hide) {
                    document.getElementById('smartTimer').classList.add('hidden');
                }
            };

            window.adjustTimer = (change) => {
                if (timerRunning) {
                    const elapsed = Math.floor((Date.now() - timerStartTime) / 1000);
                    let remaining = timerDuration - elapsed + change;

                    if (remaining > 0) {
                        // Recalcule le timerDuration pour le prochain cycle de l'intervalle
                        timerDuration = remaining;
                        timerStartTime = Date.now() - (timerDuration * 1000); // Fait en sorte que le prochain intervalle commence au nouveau "d√©part"
                        
                        // Red√©marre l'intervalle pour un rafra√Æchissement imm√©diat et r√©gulier
                        stopTimer(false);
                        startTimer(timerDuration);
                    } else {
                        // Si le temps est inf√©rieur √† z√©ro, on arr√™te
                        stopTimer(true);
                        document.getElementById('timerDisplay').textContent = "00:00";
                    }
                }
            }


            // =================================================================
            // LOGIQUE DE GESTION DU POIDS (WEIGHT & IMC)
            // =================================================================
            function calcInstantBMI() {
                const w = parseFloat(document.getElementById('inputWeight').value);
                const h = parseFloat(document.getElementById('inputHeight').value);

                if (w > 0 && h > 0) {
                    const bmi = (w / ((h / 100) * (h / 100))).toFixed(1);
                    document.getElementById('bmiResult').innerText = bmi;
                    document.getElementById('bmiText').innerText = (bmi < 18.5 ? "Maigreur" : (bmi < 25 ? "Normal" : (bmi < 30 ? "Surpoids" : "Ob√©sit√©")));
                } else {
                    document.getElementById('bmiResult').innerText = "--";
                    document.getElementById('bmiText').innerText = "--";
                }
            }

            ['inputWeight', 'inputHeight', 'inputAge'].forEach(id => document.getElementById(id).addEventListener('input', calcInstantBMI));

            window.openWeightModal = () => {
                document.getElementById('weightModal').classList.remove('hidden');
                document.body.classList.add('modal-open');
                const last = weightHistory[weightHistory.length - 1];
                if (last) {
                    document.getElementById('inputWeight').value = last.weight;
                    document.getElementById('inputHeight').value = last.height || '';
                    document.getElementById('inputAge').value = last.age || '';
                    calcInstantBMI(); // Calcule l'IMC initial au chargement
                }
            }

            window.closeWeightModal = () => {
                document.getElementById('weightModal').classList.add('hidden');
                document.body.classList.remove('modal-open');
            }

            window.saveWeightData = () => {
                const w = parseFloat(document.getElementById('inputWeight').value);
                const h = parseFloat(document.getElementById('inputHeight').value);
                const a = parseInt(document.getElementById('inputAge').value);
                const date = new Date().toISOString().split('T')[0];

                if (w > 0 && h > 0 && a > 0) {
                    const newEntry = {
                        date,
                        weight: w,
                        height: h,
                        age: a
                    };

                    // Remplace l'entr√©e d'aujourd'hui si elle existe, sinon ajoute
                    const existingIndex = weightHistory.findIndex(entry => entry.date === date);
                    if (existingIndex > -1) {
                        weightHistory[existingIndex] = newEntry;
                    } else {
                        weightHistory.push(newEntry);
                    }

                    // Trier par date pour l'affichage du graphique
                    weightHistory.sort((a, b) => new Date(a.date) - new Date(b.date));

                    localStorage.setItem(WEIGHT_STORAGE_KEY, JSON.stringify(weightHistory));
                    updateWeightUI();
                    closeWeightModal();
                } else {
                    alert("Veuillez remplir tous les champs (Poids, Taille, √Çge) avec des valeurs valides.");
                }
            }

            function updateWeightUI() {
                if (weightHistory.length > 0) {
                    const lastEntry = weightHistory[weightHistory.length - 1];
                    document.getElementById('displayWeight').textContent = lastEntry.weight.toFixed(1);
                    // Recalculer et afficher l'IMC du dernier enregistrement
                    const bmi = (lastEntry.weight / ((lastEntry.height / 100) * (lastEntry.height / 100))).toFixed(1);
                    document.getElementById('displayBMI').textContent = bmi;
                } else {
                    document.getElementById('displayWeight').textContent = '--';
                    document.getElementById('displayBMI').textContent = '--';
                }

                renderWeightChart();
            }

            function renderWeightChart() {
                const ctx = document.getElementById('weightChart').getContext('2d');

                // D√©terminer les couleurs en fonction du th√®me
                const isDarkMode = document.body.classList.contains('dark-mode');
                const textColor = isDarkMode ? '#ECF0F1' : '#2C3E50';
                const secondaryTextColor = isDarkMode ? '#95A5A6' : '#7F8C9A';
                const areaFillColor = isDarkMode ? 'rgba(0, 191, 255, 0.2)' : 'rgba(0, 191, 255, 0.4)';


                if (chartInstance) {
                    chartInstance.destroy();
                }

                if (weightHistory.length === 0) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    return;
                }

                const labels = weightHistory.map(entry => new Date(entry.date).toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'short'
                }));
                const data = weightHistory.map(entry => entry.weight);

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Poids',
                            data: data,
                            borderColor: textColor,
                            backgroundColor: areaFillColor,
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                drawBorder: true,
                                borderColor: secondaryTextColor, // <--- Axe X LIGNE
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: secondaryTextColor, // <--- Axe X LABELS
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            y: {
                                drawBorder: true,
                                borderColor: secondaryTextColor, // <--- AXE Y LIGNE
                                grid: {
                                    color: secondaryTextColor + '20', // Lignes de grille plus claires
                                    borderDash: [5, 5]
                                },
                                ticks: {
                                    color: secondaryTextColor, // <--- AXE Y LABELS
                                    callback: function (value) {
                                        return value + ' kg';
                                    },
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                });
            }


            // =================================================================
            // CALCULATEUR 1RM
            // =================================================================
            window.openRmModal = () => {
                document.getElementById('rmModal').classList.remove('hidden');
                document.body.classList.add('modal-open');
                // R√©initialiser l'affichage
                document.getElementById('rmResult').innerText = '--';
            }

            window.closeRmModal = () => {
                document.getElementById('rmModal').classList.add('hidden');
                document.body.classList.remove('modal-open');
            }

            window.calculateRM = () => {
                const weight = parseFloat(document.getElementById('rmWeight').value);
                const reps = parseInt(document.getElementById('rmReps').value);

                if (isNaN(weight) || isNaN(reps) || weight <= 0 || reps <= 0) {
                    document.getElementById('rmResult').innerText = '--';
                    return alert('Veuillez entrer des valeurs valides.');
                }

                let rm;

                if (reps === 1) {
                    rm = weight;
                } else if (reps > 10) {
                    // La formule est moins pr√©cise au-del√† de 10-12 r√©p√©titions
                    // Utilisation de Brzycki
                    rm = weight * (36 / (37 - reps));
                } else {
                    // Utilisation de Brzycki pour 2-10 reps (la plus courante)
                    rm = weight * (36 / (37 - reps));
                }

                document.getElementById('rmResult').innerText = rm.toFixed(1);
            }

            // =================================================================
            // CALCULATEUR DE POURCENTAGES
            // =================================================================
            const percentages = [60, 65, 70, 75, 80, 85, 90, 95, 100];

            window.openPercentageModal = () => {
                document.getElementById('percentageModal').classList.remove('hidden');
                document.body.classList.add('modal-open');
                // Si l'utilisateur a enregistr√© son poids max 1RM, on le pr√©-remplit
                // (Non impl√©ment√©, mais bonne pratique)
                calculatePercentages();
            }

            window.closePercentageModal = () => {
                document.getElementById('percentageModal').classList.add('hidden');
                document.body.classList.remove('modal-open');
            }

            window.calculatePercentages = () => {
                const maxWeight = parseFloat(document.getElementById('percMaxWeight').value);
                const resultsContainer = document.getElementById('percentageResults');
                resultsContainer.innerHTML = ''; // Nettoyer

                if (isNaN(maxWeight) || maxWeight <= 0) {
                    resultsContainer.innerHTML = `
                        <div style="text-align:center; color:var(--text-secondary); padding: 20px;">
                            Entre ton 1RM pour calculer les poids.
                        </div>
                    `;
                    return;
                }

                percentages.forEach(perc => {
                    const weight = (maxWeight * (perc / 100)).toFixed(1);
                    const resultItem = document.createElement('div');
                    resultItem.style.display = 'flex';
                    resultItem.style.justifyContent = 'space-between';
                    resultItem.style.padding = '8px 0';
                    resultItem.style.borderBottom = '1px solid var(--border-color)';
                    resultItem.innerHTML = `
                        <div style="font-size:16px; font-weight:600;">${perc}% de 1RM</div>
                        <div style="font-size:18px; font-weight:700; color:var(--text-primary);">${weight} <span style="font-size:12px; font-weight:500; color: var(--text-secondary);">kg</span> </div>
                    `;
                    resultsContainer.appendChild(resultItem);
                });
            };


            // =================================================================
            // CALCULATEUR DE CALORIES (MAINTIEN)
            // =================================================================
            let calorieGender = 'male'; // Par d√©faut

            window.openCaloriesModal = () => {
                // Pr√©-remplir avec les derni√®res donn√©es connues si disponibles
                const last = weightHistory[weightHistory.length - 1];
                if (last) {
                    document.getElementById('calWeight').value = last.weight;
                    if (last.height) document.getElementById('calHeight').value = last.height;
                    if (last.age) document.getElementById('calAge').value = last.age;
                }
                document.getElementById('caloriesModal').classList.remove('hidden');
                document.body.classList.add('modal-open');
            }

            window.closeCaloriesModal = () => {
                document.getElementById('caloriesModal').classList.add('hidden');
                document.body.classList.remove('modal-open');
            }

            window.setCalorieGender = (sex, button) => {
                calorieGender = sex;
                document.querySelectorAll('#genderToggle button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            }

            window.calculateCalories = () => {
                const w = parseFloat(document.getElementById('calWeight').value);
                const h = parseFloat(document.getElementById('calHeight').value);
                const a = parseInt(document.getElementById('calAge').value);
                const activityFactor = parseFloat(document.getElementById('calActivity').value);

                if (isNaN(w) || isNaN(h) || isNaN(a) || w <= 0 || h <= 0 || a <= 0) {
                    document.getElementById('calResult').innerText = '--';
                    return alert('Veuillez entrer des valeurs valides pour le poids, la taille et l\'√¢ge.');
                }

                let bmr; // Taux M√©tabolique de Base

                if (calorieGender === 'male') {
                    // Homme: 10 * poids + 6.25 * taille - 5 * √¢ge + 5
                    bmr = (10 * w) + (6.25 * h) - (5 * a) + 5;
                } else {
                    // Femme: 10 * poids + 6.25 * taille - 5 * √¢ge - 161
                    bmr = (10 * w) + (6.25 * h) - (5 * a) - 161;
                }

                // Besoins cal. de maintien = BMR * Facteur d'activit√©
                const tdee = bmr * activityFactor;

                document.getElementById('calResult').innerText = Math.round(tdee);
            }


            // =================================================================
            // INITIALISATION FINALE
            // =================================================================
            document.getElementById('openFormButton').addEventListener('click', () => openAddExerciseModal(null, null));
            
            const setupWorkoutPage = () => {
                currentWeekStart = getWeekStart(new Date());
                renderDaySlider(currentWeekStart);
                selectDay(new Date());
            };

            // Charger l'objectif hebdomadaire dans le champ des r√©glages
            const savedGoal = getWeeklyGoal();
            document.getElementById('weeklyGoalInput').value = savedGoal;

            // Corrige l'ordre d'initialisation :
            // 1. Applique le th√®me (qui appelle updateWeightUI) une fois que tout est d√©fini.
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);

            // 2.Pour recharge l'objectif sur la page d'accueil
updateWeeklyGoalDisplay();

            // 3. Initialise l'interface
            setupWorkoutPage();
            updateDashboardSessions();
        });
    </script>
</body>

</html>