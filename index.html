<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitLife App</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div class="app-container">

        <header class="header">
            <div class="header-info">
                <h1>FitLife</h1>
                <div class="date" id="currentDate"></div>
            </div>
            <div class="settings">
                <div class="settings" onclick="switchPage('settings')"><img src="reglage.png"></div>
            </div>
        </header>

        <div id="home" class="page active">
            <div class="card gradient-border">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div class="card-label">S√©ances R√©alis√©es (Semaine)</div>
                    <div class="big-stat">
                        <span id="totalSessions">0</span>
                        <span class="stat-goal">/ 5 Objectif</span>
                    </div>
                    <div class="stats-separator">
                        <div class="background-stat">
                            <div class="stat-line" style="margin-bottom: 8px;">
                                <div class="stat-label">En salle de sport</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--accent-gym);" id="gymSessions">0</div>
                            </div>
                            <div class="stat-line">
                                <div class="stat-label">A la maison</div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--accent-home);" id="homeSessions">0
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-title">Mon Corps</div>
            <div class="card ripple" onclick="openWeightModal()">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div>
                        <div class="card-label">Poids Actuel</div>
                        <div style="font-size: 28px; font-weight: 900; color: var(--text-primary);"><span
                                id="displayWeight">--</span>
                            <span style="font-size:16px; color: var(--text-secondary);">kg</span>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="card-label">IMC</div>
                        <div style="font-size: 28px; font-weight: 900; color: var(--text-primary);" id="displayBMI">--</div>
                    </div>
                </div>
                <div style="height: 150px; width: 100%;"><canvas id="weightChart"></canvas></div>
                <div
                    style="text-align:center; cursor: pointer; font-size:11px; color:var(--text-secondary); margin-top:10px; text-transform:uppercase; letter-spacing:1px;">
                    Toucher pour mettre √† jour</div>
            </div>

            <div class="section-title">Outils</div>
            <div class="card ripple" onclick="openRmModal()"
                style="display:flex; justify-content:space-between; align-items:center; padding:20px; margin-bottom: 15px;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="icon-box">‚ö°</div>
                    <div>
                        <div style="font-weight:700; color:var(--text-primary); font-size:16px;">Calculateur 1RM</div>
                        <div style="font-size:12px; color:var(--text-secondary);">Estime ta force max</div>
                    </div>
                </div>
                <div style="color:var(--accent-gym); font-size:20px; cursor: pointer;">‚Ä∫</div>
            </div>

            <div class="card ripple" onclick="openPercentageModal()"
                style="display:flex; justify-content:space-between; align-items:center; padding:20px;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="icon-box">üìä</div>
                    <div>
                        <div style="font-weight:700; color:var(--text-primary); font-size:16px;">Zones de travail</div>
                        <div style="font-size:12px; color:var(--text-secondary);">Calcule ton poids par %</div>
                    </div>
                </div>
                <div style="color:var(--accent-gym); font-size:20px; cursor: pointer;">‚Ä∫</div>
            </div>
            </div>

        <div id="workout" class="page">
            <div class="day-slider-container">
                <button id="prevWeek" class="week-nav-btn">‚Äπ</button>
                <div class="day-slider" id="daySlider"></div>
                <button id="nextWeek" class="week-nav-btn">‚Ä∫</button>
            </div>

            <div id="actionButtonsContainer" style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" id="btnProgram" onclick="openTemplateModal()" style="flex:1;">
                    Programmes</button>
                <button class="btn-primary" id="openFormButton" style="flex:1; margin-bottom:0; display:none;">
                    Nouvelle S√©ance</button>
            </div>

            <div class="section-title" id="recapSectionTitle"
                style="display:none; margin-bottom:15px; margin-top:35px;">
                R√©capitulatif (<span id="recapDateDisplay" style="color:var(--text-primary);"></span>)
            </div>
            <div id="sessionRecap" class="session-recap-container"></div>
        </div>


        <div id="settings" class="page">
            <div class="section-title">Personnalisation</div>
            <div class="card">
                <div class="card-label" style="margin-bottom: 10px;">Th√®me de l'application</div>
                <div class="theme-selector">
                    <div class="theme-option active-theme" data-theme="light" onclick="setTheme('light', this)">
                        <div class="theme-preview preview-light">
                            <div class="dot"></div>
                        </div>
                        <label>Mode Clair</label>
                    </div>
                    <div class="theme-option" data-theme="dark" onclick="setTheme('dark', this)">
                        <div class="theme-preview preview-dark">
                            <div class="dot"></div>
                        </div>
                        <label>Mode Fonc√©</label>
                    </div>
                </div>

            </div>
        </div>
        <div class="modal-overlay hidden" id="addSessionModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2 id="modalTitle">S√©ance</h2><button class="btn-close-text"
                        onclick="closeAddSessionModal()">Fermer</button>
                </div>
                <div class="form-group" id="sessionLocationGroup">
                    <div class="toggle-switch" id="sessionTypeToggle">
                        <button data-type="gym" class="active">Salle de sport</button><button
                            data-type="home">Maison</button>
                    </div>
                </div>
                <div class="form-group"><label>Nom de l'exercice</label><input type="text" id="exerciseName"
                        placeholder="Ex: D√©velopp√© couch√©"></div>
                <div class="form-group row-group">
                    <div class="input-group"><label>S√©ries</label><input type="number" id="sets" value="3"></div>
                    <div class="input-group"><label>R√©p√©titions</label><input type="number" id="reps" value="10"></div>
                </div>
                <div class="form-group"><label>Notes</label><textarea id="notes"
                        placeholder="Sensation, poids..."></textarea></div>
                <div class="modal-actions"><button class="btn-primary full" id="saveSessionButton">Enregistrer</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay hidden" id="weightModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2>Poids & IMC</h2><button class="btn-close-text" onclick="closeWeightModal()">Fermer</button>
                </div>
                <div class="form-group row-group">
                    <div class="input-group"><label>Poids (kg)</label><input type="number" id="inputWeight"
                            placeholder="Ex:0"></div>
                    <div class="input-group"><label>Taille (cm)</label><input type="number" id="inputHeight"
                            placeholder="Ex:175"></div>
                </div>
                <div class="form-group"><label>√Çge (ans)</label><input type="number" id="inputAge" placeholder="Ex:25">
                </div>
                <div class="card" style="margin: 20px 0; text-align:center; border:1px solid var(--border-color); background:var(--bg-tertiary);">
                    <div
                        style="font-size:12px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">
                        IMC Estim√©</div>
                    <div id="bmiResult" style="font-size:40px; font-weight:900; color:var(--text-primary); line-height:1;">--</div>
                    <div id="bmiText" style="font-size:14px; font-weight:600; color:var(--text-primary); margin-top:5px;">--</div>
                </div>
                <div class="modal-actions"><button class="btn-primary full"
                        onclick="saveWeightData()">Sauvegarder</button></div>
            </div>
        </div>

        <div class="modal-overlay hidden" id="rmModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2>Calculateur 1RM</h2><button class="btn-close-text"
                        onclick="document.getElementById('rmModal').classList.add('hidden')">Fermer</button>
                </div>
                <div class="form-group row-group">
                    <div class="input-group"><label>Poids (kg)</label><input type="number" id="rmWeight"
                            placeholder="80"></div>
                    <div class="input-group"><label>R√©p√©titions</label><input type="number" id="rmReps" placeholder="8">
                    </div>
                </div>
                <div class="card" style="margin: 20px 0; text-align:center; border:1px solid var(--border-color); background:var(--bg-tertiary);">
                    <div style="font-size:12px; color:var(--text-secondary); text-transform:uppercase; letter-spacing:1px;">Max Th√©orique
                        sur une rep
                    </div>
                    <div id="rmResult" style="font-size:40px; font-weight:900; color:var(--text-primary);">--</div>
                    <div style="font-size:12px; color:var(--text-secondary);">kg</div>
                </div>
                <button class="btn-primary full" onclick="calculateRM()">Calculer</button>
            </div>
        </div>

        <div class="modal-overlay hidden" id="percentageModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2>Zones de travail (%)</h2>
                    <button class="btn-close-text"
                        onclick="document.getElementById('percentageModal').classList.add('hidden'); document.body.classList.remove('modal-open');">Fermer</button>
                </div>
                <div class="form-group">
                    <label>Ton 1RM (Poids Max sur 1 R√©p. en kg)</label>
                    <input type="number" id="percMaxWeight" placeholder="Ex: 100" oninput="calculatePercentages()">
                </div>

                <div id="percentageResults" style="margin-top: 20px; display:flex; flex-direction:column; gap:8px;">
                    <div style="text-align:center; color:var(--text-secondary); padding: 20px;">
                        Entre ton 1RM pour calculer les poids.
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-overlay hidden" id="templateModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2>Programmes</h2><button class="btn-close-text"
                        onclick="document.getElementById('templateModal').classList.add('hidden')">Fermer</button>
                </div>
                <div id="templateList" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </div>
        
        <div id="smartTimer" class="timer-float hidden">
            <div style="display:flex; flex-direction:column;">
                <span style="font-size:10px; color:var(--text-secondary); font-weight:700;">REPOS</span>
                <span id="timerDisplay"
                    style="font-size:20px; font-weight:700; color:var(--text-primary); font-family:monospace;">01:30</span>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="timer-btn" onclick="adjustTimer(-10)">-10</button>
                <button class="timer-btn" onclick="adjustTimer(+10)">+10</button>
                <button class="timer-btn stop" onclick="stopTimer()">‚úï</button>
            </div>
            <div class="timer-bar" id="timerBar"></div>
        </div>
        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchPage('home')">
                <div class="nav-icon"><img src="home.png"></div>
                <div class="nav-label">Accueil</div>
            </button>
            <button class="nav-item" onclick="switchPage('workout')">
                <div class="nav-icon"><img src="haltere.png"></div>
                <div class="nav-label">Sport</div>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =================================================================
            // LOGIQUE DE GESTION DU TH√àME
            // =================================================================
            const body = document.body;
            const themeOptions = document.querySelectorAll('.theme-option');

            window.setTheme = (theme, element) => {
                if (theme === 'dark') {
                    body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                } else {
                    body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                }

                // Met √† jour l'√©tat actif des boutons dans la page de r√©glages
                if (themeOptions.length > 0) {
                    themeOptions.forEach(opt => opt.classList.remove('active-theme'));
                    const target = document.querySelector(`.theme-option[data-theme="${theme}"]`);
                    if (target) target.classList.add('active-theme');
                }
                
                // CRUCIAL : Relance l'UI du poids pour mettre √† jour les couleurs du graphique
                if (document.getElementById('weightChart')) {
                    updateWeightUI();
                }
            };

            // =================================================================
            // D√âFINITION DES FONCTIONS ET VARIABLES
            // =================================================================
            
            let chartInstance = null;
            let weightHistory = JSON.parse(localStorage.getItem('weightHistory')) || [];

            // FONCTION CORRIG√âE : Inclus l'affichage explicite de la ligne de l'axe Y pour le mode sombre
            function updateWeightUI() {
                const last = weightHistory[weightHistory.length - 1];
                if (last && last.height) { 
                    document.getElementById('displayWeight').innerText = last.weight; 
                    const bmi = (last.weight / ((last.height / 100) ** 2)).toFixed(1); 
                    document.getElementById('displayBMI').innerText = bmi; 
                }
                
                // LECTURE DYNAMIQUE DES COULEURS √Ä PARTIR DU BODY
                const style = getComputedStyle(document.body);
                const textColor = style.getPropertyValue('--text-primary').trim() || '#2C3E50';
                // secondaryTextColor est la couleur claire utilis√©e en mode sombre pour les axes
                const secondaryTextColor = style.getPropertyValue('--text-secondary').trim() || '#7F8C9A';
                
                // D√âFINITION RADICALE : Assure que tous les textes par d√©faut sont clairs
                Chart.defaults.color = secondaryTextColor; 
                
                // Couleur de fond de la zone sous la courbe
                const areaFillColor = document.body.classList.contains('dark-mode') 
                    ? 'rgba(242, 242, 247, 0.1)' 
                    : 'rgba(44, 62, 80, 0.05)';
                
                const ctx = document.getElementById('weightChart').getContext('2d'); 
                if (chartInstance) chartInstance.destroy();

                const labels = weightHistory.map(entry => new Date(entry.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })); 
                const data = weightHistory.map(entry => entry.weight);
                
                chartInstance = new Chart(ctx, { 
                    type: 'line', 
                    data: { 
                        labels: labels, 
                        datasets: [{ 
                            label: 'Poids', 
                            data: data, 
                            borderColor: textColor, 
                            backgroundColor: areaFillColor, 
                            borderWidth: 2, tension: 0.4, pointRadius: 3, fill: true 
                        }] 
                    }, 
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { legend: { display: false } }, 
                        scales: { 
                            x: { 
                                display: true, 
                                drawBorder: true,
                                borderColor: secondaryTextColor, // <--- Axe X LIGNE : Couleur claire
                                grid: {
                                    display: false 
                                },
                                ticks: { 
                                    color: secondaryTextColor, // <--- Axe X LABELS : Couleur claire
                                    font: {
                                        size: 10 
                                    }
                                }
                            }, 
                            y: { 
                                drawBorder: true, 
                                borderColor: secondaryTextColor, // <--- AXE Y LIGNE : Couleur claire
                                grid: { 
                                    color: secondaryTextColor, // <--- AXE Y GRILLE : Couleur claire
                                    lineWidth: 0.5 
                                }, 
                                ticks: { color: secondaryTextColor } // AXE Y LABELS : Couleur claire
                            } 
                        } 
                    } 
                });
            }

            window.switchPage = (pageName) => {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                
                const targetNav = document.querySelector(`.bottom-nav .nav-item[onclick*="'${pageName}'"]`);
                if(targetNav) targetNav.classList.add('active');
                
                document.getElementById(pageName).classList.add('active');
                if (pageName === 'workout') setupWorkoutPage();
                else if (typeof closeAddSessionModal === 'function') closeAddSessionModal();
            }

            const dateElement = document.getElementById('currentDate');
            const date = new Date();
            let dateString = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            dateElement.textContent = dateString.charAt(0).toUpperCase() + dateString.slice(1);
            
            const SESSION_STORAGE_KEY = 'workoutSessions';
            let currentDate = new Date();
            let currentSelectedDate = new Date();
            let selectedDayElement = null;
            let sessionType = 'gym';
            let editingExerciseIndex = null;
            function getWeekStart(date) { const d = new Date(date); let day = d.getDay() || 7; d.setDate(d.getDate() - (day - 1)); d.setHours(0, 0, 0, 0); return d; }
            let currentWeekStart = getWeekStart(currentDate);

            function getSessions() { return JSON.parse(localStorage.getItem(SESSION_STORAGE_KEY)) || {}; }
            function saveSessions(sessions) { localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(sessions)); }
            function formatDateKey(d) { return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
            function formatDateDisplay(d) { return d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }); }

            function isPastDate(d) {
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const check = new Date(d); check.setHours(0, 0, 0, 0);
                return check.getTime() < today.getTime();
            }

            function updateDashboardSessions() {
                const allSessions = getSessions();
                let totalSessions = 0, gymSessions = 0, homeSessions = 0;
                const today = new Date(); today.setHours(0, 0, 0, 0);
                let startOfWeekDay = today.getDay() || 7;
                const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - (startOfWeekDay - 1));
                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(startOfWeek); dayDate.setDate(startOfWeek.getDate() + i);
                    const session = allSessions[formatDateKey(dayDate)];
                    if (session && session.exercises.length > 0) {
                        totalSessions++;
                        if (session.type === 'gym') gymSessions++; else homeSessions++;
                    }
                }
                document.getElementById('totalSessions').textContent = totalSessions;
                document.getElementById('gymSessions').textContent = gymSessions;
                document.getElementById('homeSessions').textContent = homeSessions;
            }

            function renderDaySlider(startOfWeek) {
                const slider = document.getElementById('daySlider'); slider.innerHTML = '';
                const allSessions = getSessions();
                let selectedDayFound = false;

                const today = new Date();
                today.setHours(0, 0, 0, 0); 

                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(startOfWeek); dayDate.setDate(startOfWeek.getDate() + i);
                    const key = formatDateKey(dayDate);
                    const dayName = dayDate.toLocaleDateString('fr-FR', { weekday: 'short' }).substring(0, 3).toUpperCase();
                    const el = document.createElement('div');
                    el.classList.add('slider-day');

                    if (allSessions[key] && allSessions[key].exercises.length > 0) el.classList.add(allSessions[key].type);

                    const checkDate = new Date(dayDate); checkDate.setHours(0, 0, 0, 0);
                    if (checkDate.getTime() === today.getTime()) {
                        el.classList.add('today');
                    }

                    if (formatDateKey(dayDate) === formatDateKey(currentSelectedDate)) {
                        el.classList.add('selected');
                        selectedDayFound = true;
                        selectedDayElement = el;
                    }

                    el.innerHTML = `<div class="day-name">${dayName}</div><div class="day-num">${dayDate.getDate()}</div>`;
                    el.onclick = () => selectDay(dayDate);
                    slider.appendChild(el);
                }
                if (!selectedDayFound) selectDay(startOfWeek);
                setTimeout(() => { if (document.querySelector('.slider-day.selected')) document.querySelector('.slider-day.selected').scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }, 0);
            }

            function selectDay(date) {
                currentSelectedDate = new Date(date);
                const dateKey = formatDateKey(currentSelectedDate);
                document.getElementById('recapDateDisplay').textContent = formatDateDisplay(currentSelectedDate);
                if (selectedDayElement) selectedDayElement.classList.remove('selected');
                document.querySelectorAll('.slider-day').forEach(el => {
                    const dayDate = new Date(currentWeekStart);
                    dayDate.setDate(currentWeekStart.getDate() + Array.from(el.parentNode.children).indexOf(el));
                    if (formatDateKey(dayDate) === formatDateKey(currentSelectedDate)) { selectedDayElement = el; el.classList.add('selected'); } else { el.classList.remove('selected'); }
                });
                displaySessionRecap(currentSelectedDate, true);

                const allSessions = getSessions();
                const btnAdd = document.getElementById('openFormButton');
                const actionContainer = document.getElementById('actionButtonsContainer');
                const isPast = isPastDate(currentSelectedDate);

                if (isPast) {
                    actionContainer.style.display = 'none'; 
                } else {
                    actionContainer.style.display = 'flex';
                    btnAdd.style.display = 'flex';
                    btnAdd.textContent = (allSessions[dateKey] && allSessions[dateKey].exercises.length > 0) ? ' Ajouter un exercice' : ' Ajout√© une s√©ance';
                }
            }

            document.getElementById('prevWeek').addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() - 7); currentSelectedDate.setDate(currentSelectedDate.getDate() - 7); renderDaySlider(currentWeekStart); });
            document.getElementById('nextWeek').addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() + 7); currentSelectedDate.setDate(currentSelectedDate.getDate() + 7); renderDaySlider(currentWeekStart); });

            function openAddExerciseModal() {
                if (isPastDate(currentSelectedDate)) return; 
                document.getElementById('exerciseName').value = ''; document.getElementById('sets').value = '3'; document.getElementById('reps').value = '10'; document.getElementById('notes').value = '';
                const key = formatDateKey(currentSelectedDate); const all = getSessions();
                if (all[key] && all[key].exercises.length > 0) {
                    document.getElementById('modalTitle').textContent = 'Ajouter un Exercice';
                    document.getElementById('sessionLocationGroup').style.display = 'none';
                    sessionType = all[key].type;
                } else {
                    document.getElementById('modalTitle').textContent = 'Nouvelle S√©ance';
                    document.getElementById('sessionLocationGroup').style.display = 'block';
                    sessionType = 'gym';
                    document.querySelector('[data-type="gym"]').classList.add('active'); document.querySelector('[data-type="home"]').classList.remove('active');
                }
                document.getElementById('addSessionModal').classList.remove('hidden');
                document.body.classList.add('modal-open');
            }
            window.closeAddSessionModal = () => { document.getElementById('addSessionModal').classList.add('hidden'); document.body.classList.remove('modal-open'); editingExerciseIndex = null; if (currentSelectedDate) selectDay(currentSelectedDate); renderDaySlider(currentWeekStart); }

            document.getElementById('sessionTypeToggle').addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn) { sessionType = btn.dataset.type; document.querySelectorAll('.toggle-switch button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            });
            document.getElementById('saveSessionButton').addEventListener('click', () => {
                const name = document.getElementById('exerciseName').value;
                const sets = parseInt(document.getElementById('sets').value);
                const reps = parseInt(document.getElementById('reps').value);
                if (!name) return alert('Nom manquant');
                const key = formatDateKey(currentSelectedDate); const all = getSessions();
                if (!all[key]) all[key] = { type: sessionType, exercises: [] };
                const newEx = { name, sets, reps, notes: document.getElementById('notes').value, series: [] };
                for (let i = 0; i < sets; i++) newEx.series.push({ reps, isDone: false });
                if (editingExerciseIndex !== null) all[key].exercises[editingExerciseIndex] = newEx;
                else { all[key].exercises.push(newEx); if (document.getElementById('sessionLocationGroup').style.display !== 'none') all[key].type = sessionType; }
                saveSessions(all); closeAddSessionModal(); selectDay(currentSelectedDate); updateDashboardSessions();
            });

            function displaySessionRecap(date, showTitle = false) {
                const container = document.getElementById('sessionRecap'); container.innerHTML = '';
                const key = formatDateKey(date); const all = getSessions(); const s = all[key];
                const recapTitle = document.getElementById('recapSectionTitle');
                if (!s || s.exercises.length === 0) { container.innerHTML = '<div class="no-session-msg">Aucune s√©ance.</div>'; recapTitle.style.display = showTitle ? 'block' : 'none'; return; }
                recapTitle.style.display = 'block';
                const isPast = isPastDate(date);
                container.innerHTML = `<div class="session-type-header ${s.type}"><span class="type-label">${s.type === 'gym' ? 'Salle de Sport' : 'Maison'}</span></div>`;
                s.exercises.forEach((ex, idx) => {
                    let seriesHtml = '<ul class="series-list">';
                    ex.series.forEach((ser, sIdx) => {
                        const btnClass = ser.isDone ? 'done' : '';
                        const check = ser.isDone ? '‚úì' : '';
                        seriesHtml += `
                    <li class="series-item ${btnClass}">
                        <div class="series-info-row">
                            <span class="series-num">S√©rie ${sIdx + 1}</span>
                            <span class="series-val">${ser.reps} Reps</span>
                        </div>
                        <button class="series-toggle-btn ${btnClass}" onclick="toggleSeries(${idx}, ${sIdx})">${check}</button>
                    </li>`;
                    });
                    seriesHtml += '</ul>';
                    const actions = isPast ? '' : `<div class="card-actions"><button class="btn-edit" onclick="editEx(${idx})">Modifier</button><button class="btn-delete" onclick="delEx(${idx})">Supprimer</button></div>`;
                    container.innerHTML += `<div class="session-card ${s.type}"><div class="ex-header-row"><h4>${ex.name}</h4></div>${seriesHtml}${actions}</div>`;
                });
            }

            // FONCTION CORRIG√âE : Le contr√¥le de date pass√©e est ici
            window.toggleSeries = (exIdx, sIdx) => {
                // Si la date est pass√©e, on bloque la modification et le timer
                if (isPastDate(currentSelectedDate)) return; 
                
                const key = formatDateKey(currentSelectedDate); const all = getSessions();
                const val = !all[key].exercises[exIdx].series[sIdx].isDone;
                all[key].exercises[exIdx].series[sIdx].isDone = val;
                saveSessions(all); selectDay(currentSelectedDate);
                
                // D√âCLENCHE LE TIMER UNIQUEMENT SI ON COCHE (val === true)
                if (val === true) startTimer(90);
            }

            window.editEx = (idx) => {
                const all = getSessions(); const dateKey = formatDateKey(currentSelectedDate); const ex = all[dateKey].exercises[idx];
                document.getElementById('exerciseName').value = ex.name; document.getElementById('sets').value = ex.sets;
                document.getElementById('reps').value = ex.reps; document.getElementById('notes').value = ex.notes;
                editingExerciseIndex = idx; document.getElementById('modalTitle').textContent = 'Modifier';
                document.getElementById('addSessionModal').classList.remove('hidden');
            }
            window.delEx = (idx) => {
                if (confirm('Etes-vous sur de bien vouloir supprimer cet exercice ?')) {
                    const all = getSessions(); const dateKey = formatDateKey(currentSelectedDate);
                    all[dateKey].exercises.splice(idx, 1); if (all[dateKey].exercises.length === 0) delete all[dateKey];
                    saveSessions(all); selectDay(currentSelectedDate); updateDashboardSessions(); renderDaySlider(currentWeekStart);
                }
            }

            function calcInstantBMI() {
                const w = parseFloat(document.getElementById('inputWeight').value); const h = parseFloat(document.getElementById('inputHeight').value);
                if (w > 0 && h > 0) { const bmi = (w / ((h / 100) * (h / 100))).toFixed(1); document.getElementById('bmiResult').innerText = bmi; document.getElementById('bmiText').innerText = (bmi < 18.5 ? "Maigreur" : (bmi < 25 ? "Normal" : "Surpoids")); }
                else { document.getElementById('bmiResult').innerText = "--"; document.getElementById('bmiText').innerText = "--"; }
            }
            ['inputWeight', 'inputHeight', 'inputAge'].forEach(id => document.getElementById(id).addEventListener('input', calcInstantBMI));

            window.openWeightModal = () => { document.getElementById('weightModal').classList.remove('hidden'); document.body.classList.add('modal-open'); const last = weightHistory[weightHistory.length - 1]; if (last) { document.getElementById('inputWeight').value = last.weight; document.getElementById('inputHeight').value = last.height || ''; document.getElementById('inputAge').value = last.age || ''; calcInstantBMI(); } }
            window.closeWeightModal = () => { document.getElementById('weightModal').classList.add('hidden'); document.body.classList.remove('modal-open'); }
            window.saveWeightData = () => {
                const w = parseFloat(document.getElementById('inputWeight').value); const h = parseFloat(document.getElementById('inputHeight').value); const a = parseFloat(document.getElementById('inputAge').value);
                if (w && h) {
                    const todayKey = new Date().toISOString().substring(0, 10);
                    weightHistory = weightHistory.filter(e => new Date(e.date).toISOString().substring(0, 10) !== todayKey);
                    weightHistory.push({ date: new Date().toISOString(), weight: w, height: h, age: a });
                    weightHistory.sort((a, b) => new Date(a.date) - new Date(b.date)); localStorage.setItem('weightHistory', JSON.stringify(weightHistory));
                    updateWeightUI(); closeWeightModal();
                }
            }

            window.openRmModal = () => { document.getElementById('rmModal').classList.remove('hidden'); }
            window.calculateRM = () => { const w = parseFloat(document.getElementById('rmWeight').value); const r = parseFloat(document.getElementById('rmReps').value); if (w && r) document.getElementById('rmResult').innerText = Math.round(w * (1 + r / 30)); }
            
            window.openPercentageModal = () => {
                document.getElementById('percentageModal').classList.remove('hidden');
                document.body.classList.add('modal-open');
                const lastRm = document.getElementById('rmResult').innerText;
                if (lastRm && lastRm !== '--') {
                    document.getElementById('percMaxWeight').value = parseFloat(lastRm);
                }
                calculatePercentages();
            };

            window.calculatePercentages = () => {
                const maxWeight = parseFloat(document.getElementById('percMaxWeight').value);
                const resultsContainer = document.getElementById('percentageResults');
                resultsContainer.innerHTML = '';
                
                if (isNaN(maxWeight) || maxWeight <= 0) {
                    resultsContainer.innerHTML = `<div style="text-align:center; color:var(--text-secondary); padding: 20px;">
                        Entre ton 1RM pour calculer les poids.
                    </div>`;
                    return;
                }

                const percentages = [100, 95, 90, 85, 80, 75, 70, 65, 60, 55, 50, 45, 40];

                percentages.forEach(percent => {
                    const rawWeight = maxWeight * (percent / 100);
                    const calculatedWeight = Math.round(rawWeight * 2) / 2;
                    
                    const resultItem = document.createElement('div');
                    resultItem.className = 'stat-line background-stat'; 
                    resultItem.style.padding = '12px';
                    
                    resultItem.innerHTML = `
                        <div class="stat-label" style="font-size: 14px;">${percent}% de 1RM</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--text-primary);">
                            ${calculatedWeight.toFixed(1)} <span style="font-size: 12px; font-weight: 500; color: var(--text-secondary);">kg</span>
                        </div>
                    `;
                    
                    resultsContainer.appendChild(resultItem);
                });
            };
            

            const templates = { "Full Body": [{ name: "Squat", s: 3, r: 10 }, { name: "D√©velopp√© Couch√©", s: 3, r: 10 }, { name: "Tractions", s: 3, r: 10 }], "Push": [{ name: "Pompes", s: 4, r: 12 }, { name: "D√©velopp√© Militaire", s: 3, r: 10 }], "Pull": [{ name: "Tractions", s: 4, r: 8 }, { name: "Rowing", s: 3, r: 10 }] };
            window.openTemplateModal = () => {
                if (isPastDate(currentSelectedDate)) return; 
                const list = document.getElementById('templateList'); list.innerHTML = '';
                Object.keys(templates).forEach(key => {
                    const btn = document.createElement('button'); btn.className = 'btn-secondary'; btn.style.width = '100%'; btn.style.marginBottom = '10px'; btn.style.textAlign = 'left';
                    btn.innerHTML = `<b>${key}</b> <span style="float:right; color:var(--text-secondary)">${templates[key].length} exos</span>`;
                    btn.onclick = () => loadTemplate(key); list.appendChild(btn);
                });
                document.getElementById('templateModal').classList.remove('hidden');
            }
            function loadTemplate(key) {
                const tpl = templates[key]; const dateKey = formatDateKey(currentSelectedDate); const all = getSessions();
                if (!all[dateKey]) all[dateKey] = { type: 'gym', exercises: [] };
                tpl.forEach(item => { const newEx = { name: item.name, sets: item.s, reps: item.r, notes: "Import√©", series: [] }; for (let i = 0; i < item.s; i++) newEx.series.push({ reps: item.r, isDone: false }); all[dateKey].exercises.push(newEx); });
                saveSessions(all); document.getElementById('templateModal').classList.add('hidden'); selectDay(currentSelectedDate); updateDashboardSessions();
            }

            // =================================================================
            // LOGIQUE DU TIMER
            // =================================================================
            let timerInterval = null; let timerTime = 0; let timerTotal = 0;
            window.startTimer = (sec) => { 
                timerTime = sec; 
                timerTotal = sec; 
                document.getElementById('smartTimer').classList.remove('hidden'); 
                clearInterval(timerInterval); 
                updateTimerUI(); 
                timerInterval = setInterval(() => { 
                    timerTime--; 
                    updateTimerUI(); 
                    if (timerTime <= 0) stopTimer(); 
                }, 1000); 
            }
            window.stopTimer = () => { 
                clearInterval(timerInterval); 
                document.getElementById('smartTimer').classList.add('hidden'); 
            }
            window.adjustTimer = (val) => { 
                timerTime += val; 
                if (timerTime < 0) timerTime = 0; 
                updateTimerUI(); 
            }
            function updateTimerUI() {
                const m = Math.floor(timerTime / 60).toString().padStart(2, '0'); 
                const s = (timerTime % 60).toString().padStart(2, '0');
                document.getElementById('timerDisplay').innerText = `${m}:${s}`;
                document.getElementById('timerBar').style.width = (timerTime / timerTotal) * 100 + "%";
            }

            // =================================================================
            // INITIALISATION FINALE
            // =================================================================
            document.getElementById('openFormButton').addEventListener('click', openAddExerciseModal);
            const workoutPage = document.getElementById('workout');
            const setupWorkoutPage = () => { currentWeekStart = getWeekStart(new Date()); renderDaySlider(currentWeekStart); selectDay(new Date()); };
            
            // Chargement du th√®me au d√©marrage
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme); // Met √† jour le th√®me et appelle updateWeightUI()

            setupWorkoutPage(); 
            updateDashboardSessions(); 
        });
    </script>
</body>

</html>