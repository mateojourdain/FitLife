<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitLife App</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div class="app-container">

        <header class="header">
            <div class="header-info">
                <h1>FitLife</h1>
                <div class="date" id="currentDate"></div>
            </div>
            <div class="settings">
                <div class="settings" onclick="switchPage('settings')"><img src="reglage.png"></div>
            </div>
        </header>

        <div id="home" class="page active">
            <div class="card gradient-border">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div class="card-label">S√©ances R√©alis√©es (Semaine)</div>
                    <div class="big-stat">
                        <span id="totalSessions">0</span>
                        <span class="stat-goal">/ 5 Objectif</span>
                    </div>
                    <div class="stats-separator">
                        <div class="background-stat">
                            <div class="stat-line" style="margin-bottom: 8px;">
                                <div class="stat-label">En salle de sport</div>
                                <div style="font-size: 20px; font-weight: 700; color: #00BFFF;" id="gymSessions">0</div>
                            </div>
                            <div class="stat-line">
                                <div class="stat-label">A la maison</div>
                                <div style="font-size: 20px; font-weight: 700; color: #FF00C8;" id="homeSessions">0
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-title">Mon Corps</div>
            <div class="card ripple" onclick="openWeightModal()">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div>
                        <div class="card-label">Poids Actuel</div>
                        <div style="font-size: 28px; font-weight: 900; color: #2F3438;"><span
                                id="displayWeight">--</span>
                            <span style="font-size:16px; color: #5B6065;">kg</span>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div class="card-label">IMC</div>
                        <div style="font-size: 28px; font-weight: 900; color: #00BFFF;" id="displayBMI">--</div>
                    </div>
                </div>
                <div style="height: 150px; width: 100%;"><canvas id="weightChart"></canvas></div>
                <div
                    style="text-align:center; cursor: pointer; font-size:11px; color:#666; margin-top:10px; text-transform:uppercase; letter-spacing:1px;">
                    Toucher pour mettre √† jour</div>
            </div>

            <div class="section-title">Outils</div>
            <div class="card ripple" onclick="openRmModal()"
                style="display:flex; justify-content:space-between; align-items:center; padding:20px;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <div class="icon-box">‚ö°</div>
                    <div>
                        <div style="font-weight:700; color:#fff; font-size:16px;">Calculateur 1RM</div>
                        <div style="font-size:12px; color:#666;">Estime ta force max</div>
                    </div>
                </div>
                <div style="color:#00BFFF; font-size:20px; cursor: pointer;">‚Ä∫</div>
            </div>

            <div class="section-title">Hydratation</div>
            <div class="hydration-card">
                <div class="hydration-header">
                    <div class="hydration-count"><span id="currentWater"></span>L <span
                            style="color:#9AA4A8; font-size:14px;">/ <span id="targetWater">3.2</span>L</span></div>
                </div>
                <div class="hydration-bar">
                    <div class="hydration-progress" id="hydrationProgress"></div>
                </div>
                <div class="hydration-controls">
                    <button class="hydration-btn" onclick="adjustWater(-0.2)">‚àí</button>
                    <div class="hydration-amount">+/- 0.2L</div>
                    <button class="hydration-btn" onclick="adjustWater(0.2)">+</button>
                </div>
                <p class="indication-hydration">* Un verre d'eau de taille standard contient environ 0.2L</p>

            </div>
        </div>

        <div id="workout" class="page">
            <div class="day-slider-container">
                <button id="prevWeek" class="week-nav-btn">‚Äπ</button>
                <div class="day-slider" id="daySlider"></div>
                <button id="nextWeek" class="week-nav-btn">‚Ä∫</button>
            </div>

            <div id="actionButtonsContainer" style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-secondary" id="btnProgram" onclick="openTemplateModal()" style="flex:1;">
                    Programmes</button>
                <button class="btn-primary" id="openFormButton" style="flex:1; margin-bottom:0; display:none; color: #fff;     background: linear-gradient(135deg, #00f5ff 0%, #0080ff 100%);
">
                    Nouvelle S√©ance</button>
            </div>

            <div class="section-title" id="recapSectionTitle"
                style="display:none; margin-bottom:15px; margin-top:35px;">
                R√©capitulatif (<span id="recapDateDisplay" style="color:#fff;"></span>)
            </div>
            <div id="sessionRecap" class="session-recap-container"></div>
        </div>

        <div id="nutrition" class="page">
            <div style="text-align:center; padding:60px 20px; color:#666;">
                <div style="font-size:40px; margin-bottom:10px;">üçé</div>Module Nutrition √† venir
            </div>
        </div>

        <div id="settings class=" page">

        </div>

        <div class="modal-overlay hidden" id="addSessionModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2 id="modalTitle">S√©ance</h2><button class="btn-close-text"
                        onclick="closeAddSessionModal()">Fermer</button>
                </div>
                <div class="form-group" id="sessionLocationGroup">
                    <div class="toggle-switch" id="sessionTypeToggle">
                        <button data-type="gym" class="active">Salle de sport</button><button
                            data-type="home">Maison</button>
                    </div>
                </div>
                <div class="form-group"><label>Nom de l'exercice</label><input type="text" id="exerciseName"
                        placeholder="Ex: D√©velopp√© couch√©"></div>
                <div class="form-group row-group">
                    <div class="input-group"><label>S√©ries</label><input type="number" id="sets" value="3"></div>
                    <div class="input-group"><label>R√©p√©titions</label><input type="number" id="reps" value="10"></div>
                </div>
                <div class="form-group"><label>Notes</label><textarea id="notes"
                        placeholder="Sensation, poids..."></textarea></div>
                <div class="modal-actions"><button class="btn-primary full" id="saveSessionButton">Enregistrer</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay hidden" id="weightModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2>Poids & IMC</h2><button class="btn-close-text" onclick="closeWeightModal()">Fermer</button>
                </div>
                <div class="form-group row-group">
                    <div class="input-group"><label>Poids (kg)</label><input type="number" id="inputWeight"
                            placeholder="Ex:0"></div>
                    <div class="input-group"><label>Taille (cm)</label><input type="number" id="inputHeight"
                            placeholder="Ex:175"></div>
                </div>
                <div class="form-group"><label>√Çge (ans)</label><input type="number" id="inputAge" placeholder="Ex:25">
                </div>
                <div class="card" style="margin: 20px 0; text-align:center; border:1px solid #333; background:#0a0a0a;">
                    <div
                        style="font-size:12px; color:#666; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">
                        IMC Estim√©</div>
                    <div id="bmiResult" style="font-size:40px; font-weight:900; color:#00BFFF; line-height:1;">--</div>
                    <div id="bmiText" style="font-size:14px; font-weight:600; color:#fff; margin-top:5px;">--</div>
                </div>
                <div class="modal-actions"><button class="btn-primary full"
                        onclick="saveWeightData()">Sauvegarder</button></div>
            </div>
        </div>

        <div class="modal-overlay hidden" id="rmModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2>Calculateur 1RM</h2><button class="btn-close-text"
                        onclick="document.getElementById('rmModal').classList.add('hidden')">Fermer</button>
                </div>
                <div class="form-group row-group">
                    <div class="input-group"><label>Poids (kg)</label><input type="number" id="rmWeight"
                            placeholder="80"></div>
                    <div class="input-group"><label>R√©p√©titions</label><input type="number" id="rmReps" placeholder="8">
                    </div>
                </div>
                <div class="card" style="margin: 20px 0; text-align:center; border:1px solid #333; background:#0a0a0a;">
                    <div style="font-size:12px; color:#666; text-transform:uppercase; letter-spacing:1px;">Max Th√©orique
                        sur une rep
                    </div>
                    <div id="rmResult" style="font-size:40px; font-weight:900; color:#00BFFF;">--</div>
                    <div style="font-size:12px; color:#666;">kg</div>
                </div>
                <button class="btn-primary full" onclick="calculateRM()">Calculer</button>
            </div>
        </div>

        <div class="modal-overlay hidden" id="templateModal">
            <div class="modal-content">
                <div class="modal-header-row">
                    <h2>Programmes</h2><button class="btn-close-text"
                        onclick="document.getElementById('templateModal').classList.add('hidden')">Fermer</button>
                </div>
                <div id="templateList" style="display:flex; flex-direction:column; gap:10px;"></div>
            </div>
        </div>

        <div id="smartTimer" class="timer-float hidden">
            <div style="display:flex; flex-direction:column;">
                <span style="font-size:10px; color:#888; font-weight:700;">REPOS</span>
                <span id="timerDisplay"
                    style="font-size:20px; font-weight:700; color:#fff; font-family:monospace;">01:30</span>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="timer-btn" onclick="adjustTimer(-10)">-10</button>
                <button class="timer-btn" onclick="adjustTimer(+10)">+10</button>
                <button class="timer-btn stop" onclick="stopTimer()">‚úï</button>
            </div>
            <div class="timer-bar" id="timerBar"></div>
        </div>

        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchPage('home')">
                <div class="nav-icon"><img src="home.png"></div>
                <div class="nav-label">Accueil</div>
            </button>
            <button class="nav-item" onclick="switchPage('workout')">
                <div class="nav-icon"><img src="haltere.png"></div>
                <div class="nav-label">Sport</div>
            </button>
            <button class="nav-item" onclick="switchPage('nutrition')">
                <div class="nav-icon"><img src="nourriture.png"></div>
                <div class="nav-label">Nutrition</div>
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            window.switchPage = (pageName) => {
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                event.target.closest('.nav-item')?.classList.add('active');
                document.getElementById(pageName).classList.add('active');
                if (pageName === 'workout') setupWorkoutPage();
                else if (typeof closeAddSessionModal === 'function') closeAddSessionModal();
            }

            const dateElement = document.getElementById('currentDate');
            const date = new Date();
            let dateString = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
            dateElement.textContent = dateString.charAt(0).toUpperCase() + dateString.slice(1);

            const TARGET_WATER = 3.2;
            const STORAGE_KEY = 'dailyWaterAmount';
            let currentWater = parseFloat(localStorage.getItem(STORAGE_KEY)) || 1.6;
            window.updateHydrationUI = () => {
                document.getElementById('currentWater').textContent = currentWater.toFixed(1);
                document.getElementById('hydrationProgress').style.width = Math.min(100, (currentWater / TARGET_WATER) * 100) + '%';
                localStorage.setItem(STORAGE_KEY, currentWater.toFixed(1));
            }
            window.adjustWater = (amount) => { currentWater = Math.max(0, parseFloat((currentWater + amount).toFixed(1))); updateHydrationUI(); }
            updateHydrationUI();

            const SESSION_STORAGE_KEY = 'workoutSessions';
            let currentDate = new Date();
            let currentSelectedDate = new Date();
            let selectedDayElement = null;
            let sessionType = 'gym';
            let editingExerciseIndex = null;
            function getWeekStart(date) { const d = new Date(date); let day = d.getDay() || 7; d.setDate(d.getDate() - (day - 1)); d.setHours(0, 0, 0, 0); return d; }
            let currentWeekStart = getWeekStart(currentDate);

            function getSessions() { return JSON.parse(localStorage.getItem(SESSION_STORAGE_KEY)) || {}; }
            function saveSessions(sessions) { localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(sessions)); }
            function formatDateKey(d) { return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`; }
            function formatDateDisplay(d) { return d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' }); }

            // FONCTION CRUCIALE : V√©rifie si la date est STRICTEMENT pass√©e (hier ou avant)
            function isPastDate(d) {
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const check = new Date(d); check.setHours(0, 0, 0, 0);
                return check.getTime() < today.getTime();
            }

            function updateDashboardSessions() {
                const allSessions = getSessions();
                let totalSessions = 0, gymSessions = 0, homeSessions = 0;
                const today = new Date(); today.setHours(0, 0, 0, 0);
                let startOfWeekDay = today.getDay() || 7;
                const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - (startOfWeekDay - 1));
                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(startOfWeek); dayDate.setDate(startOfWeek.getDate() + i);
                    const session = allSessions[formatDateKey(dayDate)];
                    if (session && session.exercises.length > 0) {
                        totalSessions++;
                        if (session.type === 'gym') gymSessions++; else homeSessions++;
                    }
                }
                document.getElementById('totalSessions').textContent = totalSessions;
                document.getElementById('gymSessions').textContent = gymSessions;
                document.getElementById('homeSessions').textContent = homeSessions;
            }

            function renderDaySlider(startOfWeek) {
                const slider = document.getElementById('daySlider'); slider.innerHTML = '';
                const allSessions = getSessions();
                let selectedDayFound = false;

                const today = new Date();
                today.setHours(0, 0, 0, 0); // Jour actuel sans l'heure

                for (let i = 0; i < 7; i++) {
                    const dayDate = new Date(startOfWeek); dayDate.setDate(startOfWeek.getDate() + i);
                    const key = formatDateKey(dayDate);
                    const dayName = dayDate.toLocaleDateString('fr-FR', { weekday: 'short' }).substring(0, 3).toUpperCase();
                    const el = document.createElement('div');
                    el.classList.add('slider-day');

                    // MARQUEUR DE S√âANCE (le point)
                    if (allSessions[key] && allSessions[key].exercises.length > 0) el.classList.add(allSessions[key].type);

                    // MISE EN √âVIDENCE DU JOUR ACTUEL
                    const checkDate = new Date(dayDate); checkDate.setHours(0, 0, 0, 0);
                    if (checkDate.getTime() === today.getTime()) {
                        el.classList.add('today');
                    }

                    // S√âLECTION ACTUELLE
                    if (formatDateKey(dayDate) === formatDateKey(currentSelectedDate)) {
                        el.classList.add('selected');
                        selectedDayFound = true;
                        selectedDayElement = el;
                    }

                    el.innerHTML = `<div class="day-name">${dayName}</div><div class="day-num">${dayDate.getDate()}</div>`;
                    el.onclick = () => selectDay(dayDate);
                    slider.appendChild(el);
                }
                if (!selectedDayFound) selectDay(startOfWeek);
                setTimeout(() => { if (document.querySelector('.slider-day.selected')) document.querySelector('.slider-day.selected').scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }, 0);
            }

            function selectDay(date) {
                currentSelectedDate = new Date(date);
                const dateKey = formatDateKey(currentSelectedDate);
                document.getElementById('recapDateDisplay').textContent = formatDateDisplay(currentSelectedDate);
                if (selectedDayElement) selectedDayElement.classList.remove('selected');
                document.querySelectorAll('.slider-day').forEach(el => {
                    const dayDate = new Date(currentWeekStart);
                    dayDate.setDate(currentWeekStart.getDate() + Array.from(el.parentNode.children).indexOf(el));
                    if (formatDateKey(dayDate) === formatDateKey(currentSelectedDate)) { selectedDayElement = el; el.classList.add('selected'); } else { el.classList.remove('selected'); }
                });
                displaySessionRecap(currentSelectedDate, true);

                // LOGIQUE DE VERROUILLAGE DES JOURS PASS√âS
                const allSessions = getSessions();
                const btnAdd = document.getElementById('openFormButton');
                const actionContainer = document.getElementById('actionButtonsContainer');
                const isPast = isPastDate(currentSelectedDate);

                if (isPast) {
                    actionContainer.style.display = 'none'; // Cache les boutons si date pass√©e
                } else {
                    actionContainer.style.display = 'flex';
                    btnAdd.style.display = 'flex';
                    btnAdd.textContent = (allSessions[dateKey] && allSessions[dateKey].exercises.length > 0) ? ' Ajouter un exercice' : ' Ajout√© une s√©ance';
                }
            }

            document.getElementById('prevWeek').addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() - 7); currentSelectedDate.setDate(currentSelectedDate.getDate() - 7); renderDaySlider(currentWeekStart); });
            document.getElementById('nextWeek').addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() + 7); currentSelectedDate.setDate(currentSelectedDate.getDate() + 7); renderDaySlider(currentWeekStart); });

            function openAddExerciseModal() {
                if (isPastDate(currentSelectedDate)) return; // S√©curit√© suppl√©mentaire
                document.getElementById('exerciseName').value = ''; document.getElementById('sets').value = '3'; document.getElementById('reps').value = '10'; document.getElementById('notes').value = '';
                const key = formatDateKey(currentSelectedDate); const all = getSessions();
                if (all[key] && all[key].exercises.length > 0) {
                    document.getElementById('modalTitle').textContent = 'Ajouter un Exercice';
                    document.getElementById('sessionLocationGroup').style.display = 'none';
                    sessionType = all[key].type;
                } else {
                    document.getElementById('modalTitle').textContent = 'Nouvelle S√©ance';
                    document.getElementById('sessionLocationGroup').style.display = 'block';
                    sessionType = 'gym';
                    document.querySelector('[data-type="gym"]').classList.add('active'); document.querySelector('[data-type="home"]').classList.remove('active');
                }
                document.getElementById('addSessionModal').classList.remove('hidden');
                document.body.classList.add('modal-open');
            }
            window.closeAddSessionModal = () => { document.getElementById('addSessionModal').classList.add('hidden'); document.body.classList.remove('modal-open'); editingExerciseIndex = null; if (currentSelectedDate) selectDay(currentSelectedDate); renderDaySlider(currentWeekStart); }

            document.getElementById('sessionTypeToggle').addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (btn) { sessionType = btn.dataset.type; document.querySelectorAll('.toggle-switch button').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            });
            document.getElementById('saveSessionButton').addEventListener('click', () => {
                const name = document.getElementById('exerciseName').value;
                const sets = parseInt(document.getElementById('sets').value);
                const reps = parseInt(document.getElementById('reps').value);
                if (!name) return alert('Nom manquant');
                const key = formatDateKey(currentSelectedDate); const all = getSessions();
                if (!all[key]) all[key] = { type: sessionType, exercises: [] };
                const newEx = { name, sets, reps, notes: document.getElementById('notes').value, series: [] };
                for (let i = 0; i < sets; i++) newEx.series.push({ reps, isDone: false });
                if (editingExerciseIndex !== null) all[key].exercises[editingExerciseIndex] = newEx;
                else { all[key].exercises.push(newEx); if (document.getElementById('sessionLocationGroup').style.display !== 'none') all[key].type = sessionType; }
                saveSessions(all); closeAddSessionModal(); selectDay(currentSelectedDate); updateDashboardSessions();
            });

            function displaySessionRecap(date, showTitle = false) {
                const container = document.getElementById('sessionRecap'); container.innerHTML = '';
                const key = formatDateKey(date); const all = getSessions(); const s = all[key];
                const recapTitle = document.getElementById('recapSectionTitle');
                if (!s || s.exercises.length === 0) { container.innerHTML = '<div class="no-session-msg">Aucune s√©ance.</div>'; recapTitle.style.display = showTitle ? 'block' : 'none'; return; }
                recapTitle.style.display = 'block';
                const isPast = isPastDate(date);
                container.innerHTML = `<div class="session-type-header ${s.type}"><span class="type-label">${s.type === 'gym' ? 'Salle de Sport' : 'Maison'}</span></div>`;
                s.exercises.forEach((ex, idx) => {
                    let seriesHtml = '<ul class="series-list">';
                    ex.series.forEach((ser, sIdx) => {
                        const btnClass = ser.isDone ? 'done' : '';
                        const check = ser.isDone ? '‚úì' : '';
                        // MODIFICATION ICI : Affichage clair en LISTE avec distinction "S√©rie" / "Reps"
                        seriesHtml += `
                    <li class="series-item ${btnClass}">
                        <div class="series-info-row">
                            <span class="series-num">S√©rie ${sIdx + 1}</span>
                            <span class="series-val">${ser.reps} Reps</span>
                        </div>
                        <button class="series-toggle-btn ${isPast ? 'disabled' : ''}" onclick="toggleSeries(${idx}, ${sIdx})">${check}</button>
                    </li>`;
                    });
                    seriesHtml += '</ul>';
                    const actions = isPast ? '' : `<div class="card-actions"><button class="btn-edit" onclick="editEx(${idx})">Modifier</button><button class="btn-delete" onclick="delEx(${idx})">Supprimer</button></div>`;
                    container.innerHTML += `<div class="session-card ${s.type}"><div class="ex-header-row"><h4>${ex.name}</h4></div>${seriesHtml}${actions}</div>`;
                });
            }

            window.toggleSeries = (exIdx, sIdx) => {
                if (isPastDate(currentSelectedDate)) return; // S√©curit√©
                const key = formatDateKey(currentSelectedDate); const all = getSessions();
                const val = !all[key].exercises[exIdx].series[sIdx].isDone;
                all[key].exercises[exIdx].series[sIdx].isDone = val;
                saveSessions(all); selectDay(currentSelectedDate);
                if (val === true) startTimer(90);
            }

            window.editEx = (idx) => {
                const all = getSessions(); const dateKey = formatDateKey(currentSelectedDate); const ex = all[dateKey].exercises[idx];
                document.getElementById('exerciseName').value = ex.name; document.getElementById('sets').value = ex.sets;
                document.getElementById('reps').value = ex.reps; document.getElementById('notes').value = ex.notes;
                editingExerciseIndex = idx; document.getElementById('modalTitle').textContent = 'Modifier';
                document.getElementById('addSessionModal').classList.remove('hidden');
            }
            window.delEx = (idx) => {
                if (confirm('Supprimer ?')) {
                    const all = getSessions(); const dateKey = formatDateKey(currentSelectedDate);
                    all[dateKey].exercises.splice(idx, 1); if (all[dateKey].exercises.length === 0) delete all[dateKey];
                    saveSessions(all); selectDay(currentSelectedDate); updateDashboardSessions(); renderDaySlider(currentWeekStart);
                }
            }

            let weightHistory = JSON.parse(localStorage.getItem('weightHistory')) || [];
            function calcInstantBMI() {
                const w = parseFloat(document.getElementById('inputWeight').value); const h = parseFloat(document.getElementById('inputHeight').value);
                if (w > 0 && h > 0) { const bmi = (w / ((h / 100) * (h / 100))).toFixed(1); document.getElementById('bmiResult').innerText = bmi; document.getElementById('bmiText').innerText = (bmi < 18.5 ? "Maigreur" : (bmi < 25 ? "Normal" : "Surpoids")); }
                else { document.getElementById('bmiResult').innerText = "--"; document.getElementById('bmiText').innerText = "--"; }
            }
            ['inputWeight', 'inputHeight', 'inputAge'].forEach(id => document.getElementById(id).addEventListener('input', calcInstantBMI));

            window.openWeightModal = () => { document.getElementById('weightModal').classList.remove('hidden'); document.body.classList.add('modal-open'); const last = weightHistory[weightHistory.length - 1]; if (last) { document.getElementById('inputWeight').value = last.weight; document.getElementById('inputHeight').value = last.height || ''; document.getElementById('inputAge').value = last.age || ''; calcInstantBMI(); } }
            window.closeWeightModal = () => { document.getElementById('weightModal').classList.add('hidden'); document.body.classList.remove('modal-open'); }
            window.saveWeightData = () => {
                const w = parseFloat(document.getElementById('inputWeight').value); const h = parseFloat(document.getElementById('inputHeight').value); const a = parseFloat(document.getElementById('inputAge').value);
                if (w && h) {
                    const todayKey = new Date().toISOString().substring(0, 10);
                    weightHistory = weightHistory.filter(e => new Date(e.date).toISOString().substring(0, 10) !== todayKey);
                    weightHistory.push({ date: new Date().toISOString(), weight: w, height: h, age: a });
                    weightHistory.sort((a, b) => new Date(a.date) - new Date(b.date)); localStorage.setItem('weightHistory', JSON.stringify(weightHistory));
                    updateWeightUI(); closeWeightModal();
                }
            }

            let chartInstance = null;
            function updateWeightUI() {
                const last = weightHistory[weightHistory.length - 1];
                if (last && last.height) { document.getElementById('displayWeight').innerText = last.weight; const bmi = (last.weight / ((last.height / 100) ** 2)).toFixed(1); document.getElementById('displayBMI').innerText = bmi; }
                const ctx = document.getElementById('weightChart').getContext('2d'); if (chartInstance) chartInstance.destroy();
                const labels = weightHistory.map(entry => new Date(entry.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' })); const data = weightHistory.map(entry => entry.weight);
                chartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Poids', data: data, borderColor: '#00BFFF', backgroundColor: 'rgba(0, 245, 255, 0.1)', borderWidth: 2, tension: 0.4, pointRadius: 3, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: '#222' }, ticks: { color: '#666' } } } } });
            }

            window.openRmModal = () => { document.getElementById('rmModal').classList.remove('hidden'); }
            window.calculateRM = () => { const w = parseFloat(document.getElementById('rmWeight').value); const r = parseFloat(document.getElementById('rmReps').value); if (w && r) document.getElementById('rmResult').innerText = Math.round(w * (1 + r / 30)); }

            const templates = { "Full Body": [{ name: "Squat", s: 3, r: 10 }, { name: "D√©velopp√© Couch√©", s: 3, r: 10 }, { name: "Tractions", s: 3, r: 10 }], "Push": [{ name: "Pompes", s: 4, r: 12 }, { name: "D√©velopp√© Militaire", s: 3, r: 10 }], "Pull": [{ name: "Tractions", s: 4, r: 8 }, { name: "Rowing", s: 3, r: 10 }] };
            window.openTemplateModal = () => {
                if (isPastDate(currentSelectedDate)) return; // S√©curit√©
                const list = document.getElementById('templateList'); list.innerHTML = '';
                Object.keys(templates).forEach(key => {
                    const btn = document.createElement('button'); btn.className = 'btn-secondary'; btn.style.width = '100%'; btn.style.marginBottom = '10px'; btn.style.textAlign = 'left';
                    btn.innerHTML = `<b>${key}</b> <span style="float:right; color:#666">${templates[key].length} exos</span>`;
                    btn.onclick = () => loadTemplate(key); list.appendChild(btn);
                });
                document.getElementById('templateModal').classList.remove('hidden');
            }
            function loadTemplate(key) {
                const tpl = templates[key]; const dateKey = formatDateKey(currentSelectedDate); const all = getSessions();
                if (!all[dateKey]) all[dateKey] = { type: 'gym', exercises: [] };
                tpl.forEach(item => { const newEx = { name: item.name, sets: item.s, reps: item.r, notes: "Import√©", series: [] }; for (let i = 0; i < item.s; i++) newEx.series.push({ reps: item.r, isDone: false }); all[dateKey].exercises.push(newEx); });
                saveSessions(all); document.getElementById('templateModal').classList.add('hidden'); selectDay(currentSelectedDate); updateDashboardSessions();
            }

            let timerInterval = null; let timerTime = 0; let timerTotal = 0;
            window.startTimer = (sec) => { timerTime = sec; timerTotal = sec; document.getElementById('smartTimer').classList.remove('hidden'); clearInterval(timerInterval); updateTimerUI(); timerInterval = setInterval(() => { timerTime--; updateTimerUI(); if (timerTime <= 0) stopTimer(); }, 1000); }
            window.stopTimer = () => { clearInterval(timerInterval); document.getElementById('smartTimer').classList.add('hidden'); }
            window.adjustTimer = (val) => { timerTime += val; if (timerTime < 0) timerTime = 0; updateTimerUI(); }
            function updateTimerUI() {
                const m = Math.floor(timerTime / 60).toString().padStart(2, '0'); const s = (timerTime % 60).toString().padStart(2, '0');
                document.getElementById('timerDisplay').innerText = `${m}:${s}`;
                document.getElementById('timerBar').style.width = (timerTime / timerTotal) * 100 + "%";
            }

            document.getElementById('openFormButton').addEventListener('click', openAddExerciseModal);
            const workoutPage = document.getElementById('workout');
            const setupWorkoutPage = () => { currentWeekStart = getWeekStart(new Date()); renderDaySlider(currentWeekStart); selectDay(new Date()); };
            setupWorkoutPage(); updateDashboardSessions(); updateWeightUI();
        });
    </script>
</body>

</html>