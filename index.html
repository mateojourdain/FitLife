<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>FitLife App</title>
</head>

<body>

    <div class="app-container">
        <div class="header">
            <h1>FitLife </h1>
            <div class="date" id="currentDate"></div>
        </div>

        <div id="home" class="page active">

            <div class="card" style="width: 100%;     background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);     border: 1px solid #222;
    border-radius: 12px;">
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <div style="font-size: 14px; color: #9AA4A8; text-transform: uppercase; font-weight: 600;">
                        S√©ances R√©alis√©es (Semaine)
                    </div>
                    <div style="font-size: 44px; font-weight: 900; background: linear-gradient(135deg, #00f5ff 0%, #0080ff 100%);
                        background-clip: text;
                        -webkit-text-fill-color: transparent; line-height: 1;">
                        <span id="totalSessions">4

                        </span>
                        <span style="font-size: 18px; font-weight: 500; margin-left: 5px;">/
                            5 Objectif</span>
                    </div>

                    <div style="margin-top: 10px; border-top: 1px solid #202025; padding-top: 10px;">
                        <div class="background">
                            <div class="stat-line" style="margin-bottom: 8px;">
                                <div style="font-size: 14px;     color: #666; font-weight: 600;">En salle de sport</div>
                                <div style="font-size: 20px; font-weight: 700; color: #00BFFF;" id="gymSessions">3
                                </div>
                            </div>
                            <div class="stat-line">
                                <div style="font-size: 14px;     color: #666; font-weight: 600;">A la maison</div>
                                <div style="font-size: 20px; font-weight: 700; color: #00BFFF;" id="homeSessions">1
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="section-title">Activit√© Hebdomadaire</div>
            <div class="card">
                <div class="days-grid" id="weeklyCalendarGrid">
                    </div>
                <div class="point-container">
                    <div class="point-container" id="home-container">
                        <div class="point home"></div>
                        <h3>Maison</h3>
                    </div>
                    <div class="point-container" id="gym-container">
                        <div class="point gym"></div>
                        <h3>Salle</h3>
                    </div>
                </div>
            </div>

            <div class="section-title">hydratation</div>
            <div class="hydration-card">

                <div class="hydration-header">
                    <div class="hydration-count"><span id="currentWater"></span>L / <span id="targetWater">3.2</span>L
                    </div>
                </div>
                <div class="hydration-bar">
                    <div class="hydration-progress" id="hydrationProgress"></div>
                </div>
                <div class="hydration-target">Objectif quotidien</div>
                <div class="hydration-controls">
                    <button class="hydration-btn" onclick="adjustWater(-0.2)">‚àí</button>
                    <div class="hydration-amount">+/- 0.2L</div>
                    <button class="hydration-btn" onclick="adjustWater(0.2)">+</button>
                </div>

                <p class="indication-hydration">* Un verre d'eau de taille standard contient environ 0.2L</p>
            </div>

        </div>

        <div id="workout" class="page">
            <div class="months-header">
                <button id="prevMonth" class="nav-button">‚Äπ</button>
                <h2 id="monthYear"></h2>
                <button id="nextMonth" class="nav-button">‚Ä∫</button>
            </div>

            <div class="calendar-container" id="calendarContainer">
                <div class="calendar-days-header">
                    <span>Lun</span>
                    <span>Mar</span>
                    <span>Mer</span>
                    <span>Jeu</span>
                    <span>Ven</span>
                    <span>Sam</span>
                    <span>Dim</span>
                </div>

                <div class="calendar-grid" id="calendarGrid">
                </div>
                <div class="point-container">
                    <div class="point-container" id="home-container">
                        <div class="point home"></div>
                        <h3>Maison</h3>
                    </div>
                    <div class="point-container" id="gym-container">
                        <div class="point gym"></div>
                        <h3>Salle</h3>
                    </div>
                </div>
            </div>

            <div class="event-details hidden" id="eventDetails">
                <button class="back-to-calendar" onclick="showCalendarView()">
                    Voir le calendrier
                </button>
                <h3 id="selectedDateDisplay"></h3>

                <button class="btn-primary" id="openFormButton">+ Nouvelle S√©ance</button>

                <div id="sessionRecap" class="session-recap-container">
                </div>
            </div>
        </div>

        <div id="nutrition" class="page">
        </div>


        <div class="add-session-modal hidden" id="addSessionModal">
            <div class="modal-content">
                <h2 id="modalTitle">Ajouter une S√©ance</h2>
                <div class="form-group session-type-group" id="sessionLocationGroup"> <label>Lieu de la s√©ance</label>
                    <div class="toggle-switch" id="sessionTypeToggle">
                        <button data-type="gym" class="active">Salle de sport</button>
                        <button data-type="home">Maison</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="exerciseName">Nom de l'exercice</label>
                    <input type="text" id="exerciseName" placeholder="Ex: D√©velopp√© couch√©">
                </div>

                <div class="form-group row-group">
                    <div class="input-group">
                        <label for="sets">S√©ries</label>
                        <input type="number" id="sets" value="3" min="1">
                    </div>
                    <div class="input-group">
                        <label for="reps">R√©p√©titions</label>
                        <input type="number" id="reps" value="10" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Notes (Optionnel)</label>
                    <textarea id="notes" placeholder="Sensation, poids utilis√©, etc."></textarea>
                </div>

                <div class="form-group">
                    <button class="btn-secondary" id="addPhotoButton">
                        Ajouter une Photo (Optionnel)
                    </button>
                </div>

                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeAddSessionModal()">Annuler</button>
                    <button class="btn-prim" id="saveSessionButton">Enregistrer</button>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchPage('home')">
                <div class="nav-icon"><img src="home.png"></div>
                <div class="nav-label">Accueil</div>
            </button>
            <button class="nav-item" onclick="switchPage('workout')">
                <div class="nav-icon"><img src="haltere.png"></div>
                <div class="nav-label">Sport</div>
            </button>
            <button class="nav-item" onclick="switchPage('nutrition')">
                <div class="nav-icon"><img src="nourriture.png"></div>
                <div class="nav-label">Nutrition</div>
            </button>
        </div>
    </div>
</body>


<script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- 1. FONCTIONS UTILITAIRES GLOBALES ---

        /**
         * Bascule entre les diff√©rentes pages de l'application.
         */
        window.switchPage = (pageName) => {
            const pages = document.querySelectorAll('.page');
            const navItems = document.querySelectorAll('.nav-item');

            pages.forEach(page => page.classList.remove('active'));
            navItems.forEach(item => item.classList.remove('active'));

            document.getElementById(pageName).classList.add('active');

            // Trouver le bouton de navigation cliqu√©
            const clickedItem = event.target.closest('.nav-item');
            if (clickedItem) {
                clickedItem.classList.add('active');
            }

            // Ex√©cuter l'initialisation sp√©cifique √† la page Sport si n√©cessaire
            if (pageName === 'workout') {
                setupWorkoutPage();
            } else {
                // Si on quitte la page Sport, on s'assure que la modal est cach√©e
                if (typeof closeAddSessionModal === 'function') {
                    closeAddSessionModal();
                }
            }
        }


        // --- 2. LOGIQUE PAGE ACCUEIL (Date) ---

        const dateElement = document.getElementById('currentDate');
        const date = new Date();
        const options = {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        };
        let dateString = date.toLocaleDateString('fr-FR', options);

        // Met la premi√®re lettre de la date ET du mois en majuscule
        dateString = dateString
            .split(' ')
            .map((word, i) => {
                if (i === 0 || (i > 1 && isNaN(word))) {
                    return word.charAt(0).toUpperCase() + word.slice(1);
                }
                return word;
            })
            .join(' ');

        dateElement.textContent = dateString;


        // --- 3. LOGIQUE PAGE ACCUEIL (Hydratation) ---

        const TARGET_WATER = 3.2;
        const STORAGE_KEY = 'dailyWaterAmount';
        const targetWaterElement = document.getElementById('targetWater');
        targetWaterElement.textContent = TARGET_WATER.toFixed(1);


        function getInitialWaterAmount() {
            const storedAmount = localStorage.getItem(STORAGE_KEY);
            return parseFloat(storedAmount) || 1.6;
        }

        let currentWater = getInitialWaterAmount();

        /**
         * Met √† jour l'affichage des litres et de la barre de progression.
         */
        window.updateHydrationUI = () => {
            const currentWaterElement = document.getElementById('currentWater');
            const progressElement = document.getElementById('hydrationProgress');

            currentWaterElement.textContent = currentWater.toFixed(1);

            let percentage = (currentWater / TARGET_WATER) * 100;
            percentage = Math.min(100, Math.max(0, percentage));

            progressElement.style.width = percentage + '%';
            localStorage.setItem(STORAGE_KEY, currentWater.toFixed(1));
        }

        /**
         * Modifie la quantit√© d'eau bue.
         */
        window.adjustWater = (amount) => {
            currentWater = parseFloat((currentWater + amount).toFixed(1));

            if (currentWater < 0) {
                currentWater = 0;
            }

            updateHydrationUI();
        }

        updateHydrationUI(); // Appel initial au chargement



        // --- 4. LOGIQUE PAGE SPORT (Variables & Constantes) ---

        const SESSION_STORAGE_KEY = 'workoutSessions';
        const calendarContainer = document.getElementById('calendarContainer');
        const eventDetails = document.getElementById('eventDetails');
        const selectedDateDisplay = document.getElementById('selectedDateDisplay');
        const openFormButton = document.getElementById('openFormButton');
        const addSessionModal = document.getElementById('addSessionModal');
        const saveSessionButton = document.getElementById('saveSessionButton');
        const sessionTypeToggle = document.getElementById('sessionTypeToggle');
        const sessionRecap = document.getElementById('sessionRecap');
        const modalTitle = document.getElementById('modalTitle');
        const sessionLocationGroup = document.getElementById('sessionLocationGroup');
        const weeklyCalendarGrid = document.getElementById('weeklyCalendarGrid'); // NOUVEAU
        const totalSessionsElement = document.getElementById('totalSessions');
        const gymSessionsElement = document.getElementById('gymSessions');
        const homeSessionsElement = document.getElementById('homeSessions');

        const monthsHeader = document.querySelector('.months-header'); // NOUVEAU: R√©f√©rence √† l'en-t√™te du mois
        const monthYearDisplay = document.getElementById('monthYear');
        const calendarGrid = document.getElementById('calendarGrid');
        const prevButton = document.getElementById('prevMonth');
        const nextButton = document.getElementById('nextMonth');
        const workoutPage = document.getElementById('workout');

        let currentDate = new Date(); // Date pour suivre le mois affich√©
        let currentSelectedDate = new Date(); // Date exacte du jour cliqu√©
        let sessionType = 'gym'; // Type de s√©ance par d√©faut ('gym' ou 'home')
        let editingExerciseIndex = null;

        const daysOfWeek = ["DIM", "LUN", "MAR", "MER", "JEU", "VEN", "SAM"];
        const months = [
            "Janvier", "F√©vrier", "Mars", "Avril", "Mai", "Juin",
            "Juillet", "Ao√ªt", "Septembre", "Octobre", "Novembre", "D√©cembre"
        ];


        // --- 5. LOGIQUE GLOBALE (Stockage & Formatage) ---

        function getSessions() {
            try {
                const storedSessions = localStorage.getItem(SESSION_STORAGE_KEY);
                return storedSessions ? JSON.parse(storedSessions) : {};
            } catch (e) {
                console.error("Erreur de lecture du localStorage:", e);
                return {};
            }
        }

        function saveSessions(sessions) {
            try {
                localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(sessions));
            } catch (e) {
                console.error("Erreur d'√©criture dans le localStorage:", e);
            }
        }

        function formatDateKey(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function formatDateDisplay(date) {
            const options = {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            };
            return date.toLocaleDateString('fr-FR', options);
        }

        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                date.getMonth() === today.getMonth() &&
                date.getFullYear() === today.getFullYear();
        }

        // --- 6. LOGIQUE PAGE ACCUEIL (Calendrier Hebdomadaire & Recap) ---

        /**
         * Met √† jour les compteurs du r√©capitulatif de s√©ances sur la page d'accueil.
         */
        function updateSessionRecap() {
            const today = new Date();
            const startOfWeek = new Date(today.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1)));
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            const allSessions = getSessions();
            let totalSessions = 0;
            let gymSessions = 0;
            let homeSessions = 0;

            for (const dateKey in allSessions) {
                const sessionDate = new Date(dateKey);
                // V√©rifie si la s√©ance est dans la semaine actuelle
                if (sessionDate >= startOfWeek && sessionDate <= endOfWeek) {
                    if (allSessions[dateKey].exercises.length > 0) {
                        totalSessions++;
                        if (allSessions[dateKey].type === 'gym') {
                            gymSessions++;
                        } else if (allSessions[dateKey].type === 'home') {
                            homeSessions++;
                        }
                    }
                }
            }

            totalSessionsElement.textContent = totalSessions;
            gymSessionsElement.textContent = gymSessions;
            homeSessionsElement.textContent = homeSessions;
        }

        /**
         * Affiche le calendrier hebdomadaire sur la page d'accueil.
         */
        function renderWeeklyCalendar() {
            const today = new Date();
            today.setHours(0, 0, 0, 0); // D√©but du jour pour comparaison

            // Calculer le d√©but de la semaine (Lundi)
            let startOfWeekDay = today.getDay(); // 0 (Dimanche) √† 6 (Samedi)
            if (startOfWeekDay === 0) startOfWeekDay = 7; // Dimanche devient 7

            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - (startOfWeekDay - 1));
            startOfWeek.setHours(0, 0, 0, 0);

            let htmlContent = '';
            const allSessions = getSessions();

            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(startOfWeek.getDate() + i);
                dayDate.setHours(0, 0, 0, 0);

                const dateKey = formatDateKey(dayDate);
                const session = allSessions[dateKey];
                const dayName = daysOfWeek[dayDate.getDay()];
                const dayNumber = dayDate.getDate();

                let circleClass = '';
                let circleContent = dayNumber;

                const isToday = dayDate.getTime() === today.getTime();
                const isPast = dayDate.getTime() < today.getTime();
                const hasSession = session && session.exercises.length > 0;

                if (hasSession) {
                    // S√©ance r√©alis√©e
                    circleClass = session.type; // 'gym' ou 'home'
                    circleContent = '‚úì';
                } else if (isPast) {
                    // Jour pass√© sans s√©ance
                    circleClass = 'missed'; // Nouvelle classe √† ajouter dans style.css
                    circleContent = '‚úï';
                }

                if (isToday) {
                    // Le style 'today' est prioritaire sur le contenu (le num√©ro du jour)
                    circleClass += ' today-circle';
                    circleContent = dayNumber;
                }

                htmlContent += `
                    <div class="day-item">
                        <div class="day-name">${dayName}</div>
                        <div class="day-circle ${circleClass.trim()}" data-day-key="${dateKey}">${circleContent}</div>
                    </div>
                `;
            }
            weeklyCalendarGrid.innerHTML = htmlContent;
            updateSessionRecap(); // Met √† jour le r√©capitulatif avec le nouveau calendrier
        }

        // --- 7. LOGIQUE PAGE SPORT (Fonctions d'Affichage et Modal) ---

        /**
         * Bascule la vue pour montrer le calendrier.
         */
        window.showCalendarView = () => {
            monthsHeader.classList.remove('hidden'); // MODIFI√â : Afficher l'en-t√™te du mois
            calendarContainer.classList.remove('hidden');
            eventDetails.classList.add('hidden');
            openFormButton.classList.remove('hidden'); // S'assurer que le bouton d'ajout est visible au retour
        }

        /**
         * Affiche les d√©tails d'un jour et g√®re la visibilit√© du bouton d'ajout/modification.
         */
        function showEventDetails(day) {
            const today = new Date();
            const selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            currentSelectedDate = selectedDate;

            // Masquer le calendrier et afficher les d√©tails
            calendarContainer.classList.add('hidden');
            eventDetails.classList.remove('hidden');
            monthsHeader.classList.add('hidden'); // MODIFI√â : Masquer l'en-t√™te du mois

            // Mise √† jour de la date affich√©e
            selectedDateDisplay.textContent = formatDateDisplay(currentSelectedDate);

            // Charger les exercices pour la date s√©lectionn√©e
            displaySessionRecap(currentSelectedDate);

            // G√©rer la visibilit√© du bouton d'ajout : Toujours visible
            openFormButton.classList.remove('hidden');

            // NOUVELLE LOGIQUE POUR LE TEXTE DU BOUTON
            const dateKey = formatDateKey(currentSelectedDate);
            const allSessions = getSessions();
            const sessionExists = allSessions[dateKey] && allSessions[dateKey].exercises.length > 0;

            if (sessionExists) {
                openFormButton.textContent = '+ Ajouter Exercice';
            } else {
                openFormButton.textContent = '+ Nouvelle S√©ance';
            }
            // FIN NOUVELLE LOGIQUE

            // G√©rer la classe 'selected' sur le jour
            calendarGrid.querySelectorAll('.day').forEach(d => d.classList.remove('selected'));
            const clickedDayElement = calendarGrid.querySelector(`.day[data-day="${day}"]`);
            if (clickedDayElement) {
                clickedDayElement.classList.add('selected');
            }
        }


        /**
         * Rend la grille du calendrier mensuel.
         */
        function renderCalendar(date) {
            const currentYear = date.getFullYear();
            const currentMonth = date.getMonth();
            const today = new Date();
            const allSessions = getSessions();

            monthYearDisplay.textContent = `${months[currentMonth]} ${currentYear}`;

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            // Calculer le d√©calage pour que la semaine commence Lundi
            let firstDayOfWeek = new Date(currentYear, currentMonth, 1).getDay(); // 0 = Dimanche
            if (firstDayOfWeek === 0) firstDayOfWeek = 7; // Dimanche devient 7
            const startDayOffset = firstDayOfWeek - 1; // 0 (Lun) √† 6 (Dim)

            calendarGrid.innerHTML = '';

            // Jours vides de d√©but de mois
            for (let i = 0; i < startDayOffset; i++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('day', 'empty');
                calendarGrid.appendChild(dayElement);
            }

            // Jours du mois
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('day', 'current-month');
                dayElement.textContent = day;
                dayElement.dataset.day = day;

                const sessionDate = new Date(currentYear, currentMonth, day);
                const dateKey = formatDateKey(sessionDate);
                const session = allSessions[dateKey]; // R√©cup√®re l'objet session
                const hasSession = session && session.exercises.length > 0;

                if (currentYear === today.getFullYear() && currentMonth === today.getMonth() && day === today.getDate()) {
                    dayElement.classList.add('today');
                }

                if (hasSession) {
                    // Modification pour prendre en compte le type de s√©ance
                    dayElement.classList.add(`${session.type}-session`);
                }

                dayElement.addEventListener('click', () => {
                    showEventDetails(day);
                });

                calendarGrid.appendChild(dayElement);
            }
        }

        // --- 8. LOGIQUE MODALE DE S√âANCE ---

        /**
         * Ouvre la modal en mode Ajout d'Exercice.
         */
        function openAddExerciseModal() {
            // R√©initialisation des champs
            document.getElementById('exerciseName').value = '';
            document.getElementById('sets').value = '3';
            document.getElementById('reps').value = '10';
            document.getElementById('notes').value = '';

            const dateKey = formatDateKey(currentSelectedDate);
            const allSessions = getSessions();
            const sessionExists = allSessions[dateKey] && allSessions[dateKey].exercises.length > 0;
            editingExerciseIndex = null;

            if (sessionExists) {
                modalTitle.textContent = 'Ajouter un Exercice';
                sessionLocationGroup.style.display = 'none';
                sessionType = allSessions[dateKey].type; // R√©utilise le type existant
            } else {
                modalTitle.textContent = 'Nouvelle S√©ance';
                sessionLocationGroup.style.display = 'block';
                // Assurer que le toggle est bien initialis√© (par d√©faut √† 'gym')
                sessionType = 'gym';
                document.querySelector('#sessionTypeToggle button[data-type="gym"]').classList.add('active');
                document.querySelector('#sessionTypeToggle button[data-type="home"]').classList.remove('active');
            }

            saveSessionButton.textContent = 'Enregistrer';
            openFormButton.classList.add('hidden'); // Masquer le bouton principal
            addSessionModal.classList.remove('hidden');
            document.body.classList.add('modal-open'); // Bloquer le d√©filement du body
        }

        /**
         * Ouvre la modal en mode Modification d'Exercice.
         */
        function openEditExerciseModal(index, exerciseData) {
            editingExerciseIndex = index;
            modalTitle.textContent = 'Modifier l\'Exercice';
            sessionLocationGroup.style.display = 'none'; // Le type de s√©ance ne change pas lors de la modif d'un exercice
            saveSessionButton.textContent = 'Mettre √† jour';

            // Remplir les champs
            document.getElementById('exerciseName').value = exerciseData.name;
            document.getElementById('sets').value = exerciseData.sets;
            document.getElementById('reps').value = exerciseData.reps;
            document.getElementById('notes').value = exerciseData.notes;

            openFormButton.classList.add('hidden');
            addSessionModal.classList.remove('hidden');
            document.body.classList.add('modal-open');
        }

        /**
         * Ferme la modal et r√©initialise l'√©tat.
         */
        window.closeAddSessionModal = () => {
            addSessionModal.classList.add('hidden');
            openFormButton.classList.remove('hidden'); // Afficher √† nouveau le bouton principal
            document.body.classList.remove('modal-open');
            editingExerciseIndex = null;
        }

        /**
         * Change le type de s√©ance dans la modal.
         */
        function handleSessionTypeToggle(event) {
            const target = event.target.closest('button');
            if (target) {
                sessionType = target.dataset.type;
                sessionTypeToggle.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('active');
                });
                target.classList.add('active');
            }
        }

        /**
         * Enregistre ou met √† jour l'exercice dans le localStorage.
         * MODIFI√â : Logique de gestion de 'seriesList' pour √™tre plus robuste
         */
        function saveSession() {
            const name = document.getElementById('exerciseName').value.trim();
            const sets = parseInt(document.getElementById('sets').value, 10);
            const reps = parseInt(document.getElementById('reps').value, 10);
            const notes = document.getElementById('notes').value.trim();

            if (!name || isNaN(sets) || sets < 1 || isNaN(reps) || reps < 1) {
                alert('Veuillez remplir le nom de l\'exercice, le nombre de s√©ries et de r√©p√©titions.');
                return;
            }

            const dateKey = formatDateKey(currentSelectedDate);
            const allSessions = getSessions();

            if (!allSessions[dateKey]) {
                allSessions[dateKey] = {
                    type: sessionType,
                    exercises: []
                };
            }
            
            // R√©cup√®re l'exercice existant pour le mode modification
            const existingExercise = editingExerciseIndex !== null ? allSessions[dateKey].exercises[editingExerciseIndex] : null;

            let seriesList;

            // Logique de cr√©ation/mise √† jour de la liste des s√©ries :
            // 1. Si c'est un nouvel exercice (editingExerciseIndex === null)
            // 2. Ou si le nombre de s√©ries a chang√© (existingExercise.sets !== sets)
            // 3. Ou si la propri√©t√© 'series' est manquante (e.g., donn√©es sauvegard√©es avant cette fonctionnalit√©)
            if (editingExerciseIndex === null || existingExercise.sets !== sets || !existingExercise.series) {
                
                // On cr√©e une nouvelle liste de s√©ries (toutes non faites)
                seriesList = [];
                for (let i = 0; i < sets; i++) {
                    seriesList.push({
                        reps: reps, // R√©p√©titions par s√©rie
                        isDone: false // √âtat de la coche
                    });
                }
            } else { 
                // Mode modification et le nombre de s√©ries est le m√™me.
                // On r√©utilise l'ancienne liste pour conserver l'√©tat des coches (isDone)
                seriesList = existingExercise.series;
                // On s'assure que le nombre de r√©p√©titions par s√©rie est √† jour
                seriesList.forEach(series => series.reps = reps);
            }
            
            // Cr√©ation de l'objet exercice (ou mise √† jour)
            const newExerciseData = {
                name: name,
                sets: sets,
                reps: reps,
                notes: notes,
                photo: '',
                series: seriesList 
            };


            if (editingExerciseIndex !== null) {
                // Mode Modification
                allSessions[dateKey].exercises[editingExerciseIndex] = newExerciseData;
            } else {
                // Mode Ajout
                allSessions[dateKey].exercises.push(newExerciseData);
            }

            // Mettre √† jour le type de s√©ance si la modal l'a permis (mode ajout)
            if (document.getElementById('sessionLocationGroup').style.display !== 'none') {
                allSessions[dateKey].type = sessionType;
            }

            // --- C'est ici que l'ex√©cution reprend ! ---
            saveSessions(allSessions);
            closeAddSessionModal();
            displaySessionRecap(currentSelectedDate);
            renderCalendar(currentDate); // Mettre √† jour l'ic√¥ne sur le calendrier
            renderWeeklyCalendar(); // Mettre √† jour le calendrier de l'accueil
            showEventDetails(currentSelectedDate.getDate()); // MODIFI√â: Met √† jour le bouton principal
        }

        /**
         * G√®re la modification d'un exercice.
         */
        function handleEditExercise(event) {
            const index = parseInt(event.currentTarget.dataset.index, 10);
            const dateKey = formatDateKey(currentSelectedDate);
            const allSessions = getSessions();
            const exerciseData = allSessions[dateKey].exercises[index];
            openEditExerciseModal(index, exerciseData);
        }

        /**
         * G√®re la suppression d'un exercice.
         */
        function deleteExercise(event) {
            if (!confirm("√ätes-vous s√ªr de vouloir supprimer cet exercice ?")) {
                return;
            }

            const indexToDelete = parseInt(event.currentTarget.dataset.index, 10);
            const dateKey = formatDateKey(currentSelectedDate);
            const allSessions = getSessions();
            const session = allSessions[dateKey];

            if (session && session.exercises.length > indexToDelete) {
                session.exercises.splice(indexToDelete, 1);

                // Supprimer la s√©ance enti√®re si elle est vide
                if (session.exercises.length === 0) {
                    delete allSessions[dateKey];
                }

                saveSessions(allSessions);
                displaySessionRecap(currentSelectedDate);
                renderCalendar(currentDate);
                renderWeeklyCalendar(); // SYNCHRONISATION
                showEventDetails(currentSelectedDate.getDate());
            }
        }

        /**
         * G√®re le clic sur la coche pour marquer une s√©rie comme faite/non faite.
         * NOUVELLE FONCTION
         */
        function toggleSeriesDone(exerciseIndex, seriesIndex) {
            const dateKey = formatDateKey(currentSelectedDate);
            const allSessions = getSessions();
            const session = allSessions[dateKey];

            if (session && session.exercises[exerciseIndex] && session.exercises[exerciseIndex].series[seriesIndex]) {
                const currentStatus = session.exercises[exerciseIndex].series[seriesIndex].isDone;
                session.exercises[exerciseIndex].series[seriesIndex].isDone = !currentStatus;

                saveSessions(allSessions);
                displaySessionRecap(currentSelectedDate); // R√©affiche la carte
            }
        }

        /**
         * G√©n√®re et affiche le r√©capitulatif des s√©ances pour une date donn√©e.
         * MODIFI√â : Ajout de la structure de liste pour les s√©ries et du bouton de coche
         */
        function displaySessionRecap(date) {
            const dateKey = formatDateKey(date);
            const allSessions = getSessions();
            const session = allSessions[dateKey];
            const exercises = session ? session.exercises : [];
            sessionRecap.innerHTML = '';

            if (exercises.length === 0) {
                sessionRecap.innerHTML = `<p class="no-session-msg">Aucune s√©ance enregistr√©e pour cette journ√©e.</p>`;
            } else {
                const sessionTypeLabel = session.type === 'gym' ? 'Salle de Sport' : '√Ä la Maison';
                const sessionTypeIcon = session.type === 'gym' ? 'üí™' : 'üè†';

                // En-t√™te de la s√©ance
                sessionRecap.innerHTML = `
                    <div class="session-type-header ${session.type}">
                        <span class="type-icon">${sessionTypeIcon}</span>
                        <span class="type-label">${sessionTypeLabel}</span>
                    </div>
                `;

                exercises.forEach((exercise, exerciseIndex) => {
                    const exerciseCard = document.createElement('div');
                    exerciseCard.classList.add('session-card');
                    exerciseCard.classList.add(session.type);

                    // --- Construction de la liste des s√©ries ---
                    let seriesHtml = '<ul class="series-list">';

                    if (exercise.series) {
                        exercise.series.forEach((series, seriesIndex) => {
                            const isDone = series.isDone;
                            const checkIcon = isDone ? '‚úì' : '';
                            const doneClass = isDone ? 'done' : '';

                            seriesHtml += `
                                <li class="series-item ${doneClass}">
                                    <div class="series-info">
                                        <span class="series-number">S√©rie ${seriesIndex + 1}</span>
                                        <span class="series-reps">${series.reps} R√©p√©titions</span>
                                    </div>
                                    <button class="series-toggle-btn" data-exercise-index="${exerciseIndex}" data-series-index="${seriesIndex}">
                                        ${checkIcon}
                                    </button>
                                </li>
                            `;
                        });
                    }
                    seriesHtml += '</ul>';
                    // ------------------------------------------

                    exerciseCard.innerHTML += `
                        <h4 class="exercise-name">${exercise.name}</h4>

                        ${seriesHtml}

                        ${exercise.notes ? `<p class="notes">Notes: ${exercise.notes}</p>` : ''}

                        <div class="card-actions">
                            <button class="btn-edit" data-index="${exerciseIndex}">Modifier</button>
                            <button class="btn-delete" data-index="${exerciseIndex}">Supprimer</button>
                        </div>
                    `;
                    sessionRecap.appendChild(exerciseCard);
                });

                // Attacher les √©couteurs d'√©v√©nements pour les boutons de coche
                sessionRecap.querySelectorAll('.series-toggle-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const exIndex = parseInt(e.currentTarget.dataset.exerciseIndex, 10);
                        const sIndex = parseInt(e.currentTarget.dataset.seriesIndex, 10);
                        toggleSeriesDone(exIndex, sIndex);
                    });
                });
                // Attacher les √©couteurs d'√©v√©nements pour les boutons d'action
                sessionRecap.querySelectorAll('.btn-edit').forEach(button => {
                    button.addEventListener('click', handleEditExercise);
                });
                sessionRecap.querySelectorAll('.btn-delete').forEach(button => {
                    button.addEventListener('click', deleteExercise);
                });
            }
        }


        // --- 9. INITIALISATION ET √âCOUTEURS D'√âV√âNEMENTS ---

        // √âcouteurs pour la navigation du calendrier
        prevButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
            showCalendarView();
        });

        nextButton.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
            showCalendarView();
        });

        // √âcouteurs pour la modal
        openFormButton.addEventListener('click', openAddExerciseModal);
        saveSessionButton.addEventListener('click', saveSession);
        sessionTypeToggle.addEventListener('click', handleSessionTypeToggle);

        /**
         * Fonction d'initialisation de la page Sport.
         */
        const setupWorkoutPage = () => {
            renderCalendar(currentDate);
            showCalendarView();

            const todayElement = calendarGrid.querySelector('.today');
            if (todayElement) {
                setTimeout(() => {
                    todayElement.click();
                }, 10);
            }
        };

        // Initialisation du calendrier du mois et de la semaine au chargement
        renderCalendar(currentDate);
        renderWeeklyCalendar();

        // Initialisation de la page Sport si active au chargement
        if (workoutPage.classList.contains('active')) {
            setupWorkoutPage();
        }

        // √âcouteur sur les boutons de navigation du bas (pour l'initialisation)
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const pageLabel = e.currentTarget.querySelector('.nav-label').textContent;
                if (pageLabel === 'Sport') {
                    if (!workoutPage.classList.contains('active')) {
                        switchPage('workout');
                    }
                } else if (pageLabel === 'Accueil') {
                    renderWeeklyCalendar(); // Met √† jour le calendrier hebdomadaire √† chaque retour √† l'accueil
                }
            });
        });

    });
</script>

</html>